
# å•ä¾‹æ¨¡å¼
## æ¦‚å¿µ
å•ä¾‹æ¨¡å¼ï¼šæŒ‡ä¸€ä¸ªç±»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ï¼ˆgetInstanceæ–¹æ³•ï¼‰ã€‚
å¤§æ¦‚å®ç°å°±æ˜¯éšè—å…¶æ„é€ æ–¹æ³•ï¼Œå•ä¾‹æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ã€‚
ä¸€äº›å®é™…çš„åº”ç”¨åœºæ™¯æ¯”å¦‚ï¼ŒDBpool, ServletContext,ServletConfigç­‰

## å•ä¾‹æ¨¡å¼å†™æ³•

### é¥¿æ±‰å¼å•ä¾‹
åœ¨å•ä¾‹ç±»é¦–æ¬¡åŠ è½½æ—¶åˆ›å»ºå®ä¾‹ï¼›

```java
public class HungrySingleton {
    private static final HungrySingleton hungrySingleton = new HungrySingleton();

    private HungrySingleton(){}

    public static HungrySingleton getInstance(){
        return hungrySingleton;
    }
}
```
#### ä¼˜ç‚¹  
æ‰§è¡Œæ•ˆç‡é«˜ï¼Œæ²¡æœ‰åŠ ä»»ä½•é”  

#### ç¼ºç‚¹  
ç±»åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æµªè´¹ï¼›å¦‚æœå‡ºç°ç±»çš„æ•°é‡å¾ˆå¤šçš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–å¾ˆå¤šç±»ï¼Œå ç”¨å¤§é‡å†…å­˜ï¼›

#### å±€é™æ€§ 
Springå°±ä¸èƒ½ä½¿ç”¨ï¼ŒSpringå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæœ‰å¤§é‡çš„ç±»åŠ è½½ã€‚

**é¥¿æ±‰å¼çš„ç¬¬äºŒç§å†™æ³•**

```java
public class HungryStaticSingleton {

    private static final HungryStaticSingleton hungrySingleton ;

    static {
        hungrySingleton = new HungryStaticSingleton();
    }

    private HungryStaticSingleton(){}

    public static HungryStaticSingleton getInstance(){
        return hungrySingleton;
    }
}
```
åŒºåˆ«ä»…ä»…å®åœ¨ä¸ç±»åŠ è½½çš„é¡ºåºä¸åŒã€‚ğŸ‘‡


### æ‡’æ±‰å¼å•ä¾‹
è¢«å¤–éƒ¨ç±»è°ƒç”¨æ—¶æ‰åˆ›å»ºå®ä¾‹ï¼›

```java
public class LazySingleton {

    private static LazySingleton instance = null;

    private LazySingleton() {
    }

    public static  LazySingleton getInstance() {
        if (instance == null) {
            instance = new LazySingleton();
        }
        return instance;
    }
}

```

#### ä¼˜ç‚¹

èŠ‚çœäº†å†…å­˜

#### ç¼ºç‚¹

ä¸èƒ½ä¿è¯çœŸå®å•ä¾‹ï¼Œçº¿ç¨‹ä¸å®‰å…¨

#### **çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› **  

- åé¢çš„çº¿ç¨‹è¦†ç›–æ‰å‰é¢çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹
- åŒæ—¶è¿›å…¥åˆ¤æ–­æ¡ä»¶ï¼ŒæŒ‰é¡ºåºè¿”å›ï¼Œæ²¡æœ‰è¦†ç›–çš„æ—¶å€™ï¼Œå°±è¿”å›å®ä¾‹

**è§£å†³æ–¹æ³•**ï¼š

```java
public static synchorized LazySingleton getInstance() {
    if (instance == null) {
        instance = new LazySingleton();
    }
    return instance;
}
```

ä½†æ˜¯getInstanceæ–¹æ³•æ·»åŠ ä¸Šé”ä¹‹åï¼Œæ€§èƒ½ä¸‹é™ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¯·æ±‚è®¿é—®ï¼Œé™¤äº†è·å¾—é”çš„çº¿ç¨‹ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹éƒ½è¦ç­‰å¾…ã€‚

**å¦‚ä½•ä¼˜åŒ–ï¼Ÿ**

```java
public class LazyDclSingleton {

    private static LazyDclSingleton instance = null;

    private LazyDclSingleton() {
    }
    // åé¢çš„çº¿ç¨‹è¦†ç›–æ‰å‰é¢çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹
    public static LazyDclSingleton getInstance() {
        if (instance == null) {
            synchronized (LazyDclSingleton.class) {
                instance = new LazyDclSingleton();
            }
        }
        return instance;
    }
}
```
### åŒé‡æ£€æŸ¥é”

```java
public class LazyDclSingleton {

    private static volatile LazyDclSingleton instance = null;

    private LazyDclSingleton() {
    }

    public static LazyDclSingleton getInstance() {
        // æ£€æŸ¥æ˜¯å¦è¦é˜»å¡
        if (instance == null) {
            synchronized (LazyDclSingleton.class) {
                // æ£€æŸ¥æ˜¯å¦è¦åˆ›å»ºå®ä¾‹
                if (instance == null) {
                    instance = new LazyDclSingleton();
                }
            }
        }
        return instance;
    }
}
```
#### å±€é™æ€§

ä¼šå‡ºç°æŒ‡ä»¤é‡æ’åºçš„é—®é¢˜ï¼Œæœ‰å¯èƒ½è¿”å›ä¸€ä¸ªä¸å®Œæ•´çš„å®ä¾‹
è§£å†³æ–¹æ¡ˆï¼šprivate static volatile LazyDclSingleton instance = null;ï¼ˆvolatileç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼‰

#### ä¼˜ç‚¹

æ€§èƒ½é«˜ï¼Œèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨

#### ç¼ºç‚¹

ä»£ç å¯è¯»æ€§æŸ¥ï¼Œä¸å¤Ÿç¾è§‚ï¼Œä»£ç ä¸å¤Ÿä¼˜é›…  

### é™æ€å†…éƒ¨ç±»å†™æ³•
```java
/**
 * é™æ€å†…éƒ¨ç±»
 * é™æ€å†…éƒ¨ç±»åœ¨ä½¿ç”¨æ—¶æ‰è¿›è¡Œæ„å»º
 * classPath: ../LazyInnerClassSingleton.class
 *            ../LazyInnerClassSingleton$LazyHolder.class
 *
 * ä¼˜ç‚¹ï¼šå†™æ³•ä¼˜é›…ï¼Œåˆ©ç”¨äº†javaè¯­è¨€è¯­æ³•ï¼Œæ€§èƒ½ä¹Ÿé«˜ï¼Œé¿å…å†…å­˜çš„æµªè´¹
 * ç¼ºç‚¹ï¼šèƒ½å¤Ÿè¢«åå°„ç ´å
 */
public class LazyInnerClassSingleton {
    private LazyInnerClassSingleton(){}
    public static LazyInnerClassSingleton getInstance(){
        return LazyHolder.instance;
    }

    private static class LazyHolder{
        private static final LazyInnerClassSingleton instance = new LazyInnerClassSingleton();
    }
}
```
#### ä¼˜ç‚¹

1ã€å†™æ³•ä¼˜é›…ï¼Œåˆ©ç”¨äº†javaè¯­è¨€è¯­æ³•
2ã€æ€§èƒ½ä¹Ÿé«˜
3ã€é¿å…å†…å­˜çš„æµªè´¹  

#### ç¼ºç‚¹

1ã€èƒ½å¤Ÿè¢«åå°„ç ´åå•ä¾‹  

```java
/**
 * åå°„ç ´åå•ä¾‹æ¨¡å¼
 */
public class ReflectTest {
    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        Class<?> clazz = LazyInnerClassSingleton.class;
        Constructor<?> declaredConstructor = clazz.getDeclaredConstructor(null);
        declaredConstructor.setAccessible(true);
        Object instance = declaredConstructor.newInstance();
        System.err.println(instance);
    }
}
// æ‰“å°ç»“æœ com.ibli.javaBase.pattern.singleton.LazyInnerClassSingleton@38af3868
```
è§£å†³åŠæ³•ï¼š åœ¨æ„é€ å™¨ä¸­æ·»åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå®ä¾‹å·²ç»åˆ›å»ºï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢åˆ›å»ºï¼›
```
 private LazyInnerClassSingleton(){
        if (LazyHolder.instance != null){
            throw new IllegalArgumentException();
        }
    }
```
## æ³¨å†Œå¼å•ä¾‹
> å°†æ¯ä¸€ä¸ªå®ä¾‹éƒ½ç¼“å­˜åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä½¿ç”¨å”¯ä¸€æ ‡å¿—è·å–å®ä¾‹

### æšä¸¾å†™æ³•
```java
public enum  EnumSingleton  {

    INSTANCE;

    private Object object;

    public Object getObject() {
        return object;
    }

    public void setObject(Object object) {
        this.object = object;
    }

    public static EnumSingleton getInstance(){
        return INSTANCE;
    }
}
```
**ä½¿ç”¨ä¸æµ‹è¯•**

```java
public class EnumSingletonTest {

    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException {
        EnumSingleton enumSingleton =   EnumSingleton.getInstance();
        enumSingleton.setObject(new Object());

        // å°è¯•ä½¿ç”¨åå°„ç ´å
        Class<?> clazz = EnumSingleton.class;
        Constructor<?> declaredConstructor = clazz.getDeclaredConstructor(String.class,int.class);
        System.err.println(declaredConstructor);
        declaredConstructor.setAccessible(true);
        Object object = declaredConstructor.newInstance();
        System.err.println(object);
    }
}
```
**æµ‹è¯•ç»“æœ**ï¼š

```java
private com.ibli.javaBase.pattern.singleton.EnumSingleton(java.lang.String,int)
Exception in thread "main" java.lang.IllegalArgumentException: Cannot reflectively create enum objects
	at java.lang.reflect.Constructor.newInstance(Constructor.java:417)
	at com.ibli.javaBase.pattern.singleton.EnumSingletonTest.main(EnumSingletonTest.java:17)
```
**åŸå› åœ¨JDKåº•å±‚æºç ä¸­å·²ç»åšäº†é™åˆ¶**

```java
@CallerSensitive
    public T newInstance(Object ... initargs)
        throws InstantiationException, IllegalAccessException,
               IllegalArgumentException, InvocationTargetException
    {
        if (!override) {
            if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) {
                Class<?> caller = Reflection.getCallerClass();
                checkAccess(caller, clazz, null, modifiers);
            }
        }
        // ä¸èƒ½åˆ›å»ºæšä¸¾ç±»å‹
        if ((clazz.getModifiers() & Modifier.ENUM) != 0)
            throw new IllegalArgumentException("Cannot reflectively create enum objects");
        ConstructorAccessor ca = constructorAccessor;   // read volatile
        if (ca == null) {
            ca = acquireConstructorAccessor();
        }
        @SuppressWarnings("unchecked")
        T inst = (T) ca.newInstance(initargs);
        return inst;
    }
```



#### ä¼˜ç‚¹ 

å†™æ³•ä¼˜é›…ï¼Œä½¿ç”¨æ–¹ä¾¿

#### ç¼ºç‚¹  

å’Œé¥¿æ±‰å¼ä¸€æ ·ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€ æˆå¤§é‡å†…å­˜æµªè´¹  

### å®¹å™¨å¼å•ä¾‹å†™æ³•
```java
public class ContainerSingleton {

    private ContainerSingleton() {
    }
    
    private static Map<String, Object> ioc = new ConcurrentHashMap<>();

    public static Object getInstance(String className) {
        Object instance = null;
        if (!ioc.containsKey(className)) {
            try {
                instance = Class.forName(className).newInstance();
                ioc.put(className, instance);
            } catch (Exception e) {
                e.printStackTrace();
            }
            return instance;
        } else {
            return ioc.get(className);
        }
    }
}
```
æµ‹è¯•ç±»ï¼š
```java
public class ContainerSingletonTest {
    public static void main(String[] args) {
        Object o1 = ContainerSingleton.getInstance("com.ibli.javaBase.pattern.singleton.Pojo");
        Object o2 = ContainerSingleton.getInstance("com.ibli.javaBase.pattern.singleton.Pojo");
        System.err.println(o1 == o2); // true
    }
}
```

å®¹å™¨å¼å•ä¾‹å†™æ³•é€‚åˆåˆ›å»ºå¤§é‡å•ä¾‹å®ä¾‹çš„åœºæ™¯ï¼Œç±»ä¼¼ä¸Springçš„IOCå®¹å™¨ã€‚
å½“ç„¶ä¸Šé¢çš„å†™æ³•ä¹Ÿä¼šå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹å®‰å…¨é—®é¢˜


## åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼
```java
/**
 * åºåˆ—åŒ–ï¼šæŠŠå†…å­˜ä¸­å¯¹è±¡çš„çŠ¶æ€è½¬æ¢ä¸ºå­—èŠ‚ç çš„å½¢å¼ï¼Œç„¶ååœ¨æŠŠå­—èŠ‚ç ä»¥IOè¾“å‡ºæµå†™åˆ°ç£ç›˜ä¸Š
 * ååºåˆ—åŒ–ï¼š å°†æŒä¹…åŒ–çš„å­—èŠ‚ç å†…å®¹ï¼Œé€šè¿‡IOæµçš„æ–¹å¼è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç„¶ååœ¨è½¬æ¢æˆJavaå¯¹è±¡
 */
public class SerializableSingleton implements Serializable {

    private static final SerializableSingleton serializableSingleton = new SerializableSingleton();

    private SerializableSingleton() {
    }

    public static SerializableSingleton getInstance() {
        return serializableSingleton;
    }
}
```
æµ‹è¯•ç±»ï¼š
```java
public class SerializableSingletonTest {
    public static void main(String[] args) {
        SerializableSingleton s1;
        SerializableSingleton s2 = SerializableSingleton.getInstance();

        FileOutputStream fos;
        try {
            fos = new FileOutputStream("SerializableSingleton.obj");
            ObjectOutputStream oos = new ObjectOutputStream(fos);
            oos.writeObject(s2);
            oos.flush();
            oos.close();


            FileInputStream fis = new FileInputStream("SerializableSingleton.obj");
            ObjectInputStream ois = new ObjectInputStream(fis);
            s1 = (SerializableSingleton) ois.readObject();
            ois.close();

            System.out.println(s1);
            System.out.println(s2);
            System.out.println(s1 == s2);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
**ç»“æœï¼š**

```java
com.ibli.javaBase.pattern.singleton.SerializableSingleton@20ad9418
com.ibli.javaBase.pattern.singleton.SerializableSingleton@681a9515
false
```
**è§£å†³æ–¹æ³•ï¼šåœ¨SerializableSingletonä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•**

```java
    // æ¡¥æ¥æ¨¡å¼
    private Object readResolve() {
        return serializableSingleton;
    }
```
**ç»“æœ:**

```java
com.ibli.javaBase.pattern.singleton.SerializableSingleton@681a9515
com.ibli.javaBase.pattern.singleton.SerializableSingleton@681a9515
true
```
åŸå› ï¼šois.readObject();æ–¹æ³•åº•å±‚æœ‰å¯¹readResolveæ–¹æ³•çš„åˆ¤æ–­ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ä¸ªæ–¹æ³•ï¼Œä¼šåˆ©ç”¨åå°„ç”Ÿæˆä¸€ä¸ªæ–°çš„å®ä¾‹ï¼›

## ThreadLocalå•ä¾‹
ä¸‹é¢ä»‹ç»ä¸€ç§æ¯”è¾ƒå°‘è§çš„ä¸€ç§å•ä¾‹æ¨¡å¼
```java
public class ThreadLocalSingleton {

    private static final ThreadLocal<ThreadLocalSingleton> threadLocalSingleton =
            new ThreadLocal<ThreadLocalSingleton>() {
                @Override
                protected ThreadLocalSingleton initialValue() {
                    return new ThreadLocalSingleton();
                }
            };

    private ThreadLocalSingleton(){}

    public static ThreadLocalSingleton getInstance(){
        return threadLocalSingleton.get();
    }
}
```
```java
public class ThreadLocalExector implements Runnable{
    @Override
    public void run() {
        System.err.println(ThreadLocalSingleton.getInstance());
    }
}
```
**æµ‹è¯•ï¼š**

```java
public class ThreadLocalSingletonTest {

    public static void main(String[] args) {
        System.out.println(ThreadLocalSingleton.getInstance());
        System.out.println(ThreadLocalSingleton.getInstance());

        Thread thread1 = new Thread(new ThreadLocalExector());
        Thread thread2 = new Thread(new ThreadLocalExector());
        thread1.start();
        thread2.start();;
    }
}
```
**ç»“æœï¼š**

```java
com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@38af3868  1
com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@38af3868  2

com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@10c69a60  3
com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@2f1eeb2f  4
```
ä»¥ä¸Š3å’Œ4çš„ç»“æœè™½ç„¶ä¸ä¸€æ ·ï¼Œä½†æ˜¯å…¶å®ä¹Ÿæ˜¯å®ç°äº†ã€å•ä¾‹ã€‘çš„æ•ˆæœã€‚



<p align="middle"> å±±è„šå¤ªæ‹¥æŒ¤ æˆ‘ä»¬æ›´é«˜å¤„è§ã€‚ </p>
