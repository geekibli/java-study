---
title: è®¾è®¡æ¨¡å¼ä¹‹ç¾-åŸå‹æ¨¡å¼
toc: true
date: 2021-08-07 19:31:43
tags: è®¾è®¡æ¨¡å¼
categories:
---

# åŸå‹æ¨¡å¼

åŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰æŒ‡åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡å¤åˆ¶è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œå±äºåˆ›
å»ºå‹æ¨¡å¼ï¼›

åŸå‹æ¨¡å¼çš„æ ¸å¿ƒåœ¨äºå¤åˆ¶åŸå‹å¯¹è±¡ã€‚ä»¥ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„ä¸€ä¸ªå¯¹è±¡ä¸ºåŸå‹ï¼Œç›´æ¥åŸºäºå†…å­˜äºŒè¿›åˆ¶æµè¿›è¡Œå¤åˆ¶ï¼Œä¸éœ€è¦
å†ç²¾åŠ›è€—æ—¶çš„å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨æ„é€ å‡½æ•°ï¼‰ï¼Œæ€§èƒ½æå‡å¾ˆå¤šã€‚å½“å¯¹è±¡çš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶æ—¶ï¼Œå¯ä»¥æŠŠå½“å‰ç³»ç»Ÿ
å·²å­˜åœ¨çš„å¯¹è±¡ä½œä¸ºåŸå‹ï¼Œå¯¹å…¶è¿›è¡Œå¤åˆ¶ï¼ˆä¸€èˆ¬æ˜¯åŸºäºäºŒè¿›åˆ¶æµçš„å¤åˆ¶ï¼‰ï¼Œèº²é¿åˆå§‹åŒ–è¿‡ç¨‹ï¼Œä½¿å¾—æ–°å¯¹è±¡çš„åˆ›å»ºæ—¶é—´å¤§å¤§ç¼©çŸ­ï¼›

## åŸå‹æ¨¡å¼ç±»å›¾
![](https://oscimg.oschina.net/oscnet/up-85e3522fe29b05e31c4957bbcdf82eeba4c.png)
### IPrototype å®šä¹‰å…‹éš†çš„æ–¹æ³• ç±»ä¼¼äºJDKè‡ªå¸¦çš„Cloneable
```java
public interface IPrototype<T> {
    T clone();
}
```

### ConcretePrototype å…·ä½“çš„è¦å…‹éš†çš„å¯¹è±¡
```java
public class ConcretePrototype implements IPrototype {

    private int age;
    private String name;

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
    
    // å¯èƒ½æˆ‘ä»¬å¹³æ—¶éƒ½è¿™ä¹ˆå»å¤åˆ¶å¯¹è±¡
    @Override
    public ConcretePrototype clone() {
        ConcretePrototype concretePrototype = new ConcretePrototype();
        concretePrototype.setAge(this.age);
        concretePrototype.setName(this.name);
        return concretePrototype;
    }

    @Override
    public String toString() {
        return "ConcretePrototype{" +
                "age=" + age +
                ", name='" + name + '\'' +
                '}';
    }
}
```

### Client å®¢æˆ·ç«¯ æµ‹è¯•
```java
   public static void main(String[] args) {
        //åˆ›å»ºåŸå‹å¯¹è±¡
        ConcretePrototype prototype = new ConcretePrototype();
        prototype.setAge(18);
        prototype.setName("Tom");
        System.out.println(prototype);

        //æ‹·è´åŸå‹å¯¹è±¡
        ConcretePrototype cloneType = prototype.clone();
        System.out.println(cloneType);
        System.err.println(cloneType == prototype);
    }
```
è¿è¡Œç»“æœï¼š
```java
ConcretePrototype{age=18, name='Tom'}
ConcretePrototype{age=18, name='Tom'}
false 
```
### å®ç°JDK Cloneableçš„å…‹éš†å¯¹è±¡å†™æ³•
```java
public class ConcretePrototype1 implements Cloneable {

    private int age;
    private String name;

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public ConcretePrototype1 clone()  {
        Object clone = null;
        try {
            clone = super.clone();
        } catch (CloneNotSupportedException e) {
            e.printStackTrace();
            System.err.println("Clone Error!");
        }
        return (ConcretePrototype1) clone;
    }

    @Override
    public String toString() {
        return "ConcretePrototype{" +
                "age=" + age +
                ", name='" + name + '\'' +
                '}';
    }
}
```
è¾“å‡ºç»“æœåŒä¸Šï¼›ä»¥ä¸Šçš„ä¸¤ä¸ªå±æ€§éƒ½æ˜¯åŸºæœ¬æ•°æ®ç±»å‹å’ŒStringï¼Œå¹¶æ²¡æœ‰å¼•ç”¨ç±»å‹ï¼Œä¸‹é¢æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å±æ€§æµ‹è¯•ä»¥ä¸‹ğŸ‘‡ğŸ‘‡  

### ConcretePrototypeæ·»åŠ ä¸€ä¸ªListç±»å‹å±æ€§
```java
public class ConcretePrototype implements IPrototype {

    private int age;
    private String name;
    private List<String> hobbies;

    public List<String> getHobbies() {
        return hobbies;
    }

    public void setHobbies(List<String> hobbies) {
        this.hobbies = hobbies;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public ConcretePrototype clone() {
        ConcretePrototype concretePrototype = new ConcretePrototype();
        concretePrototype.setAge(this.age);
        concretePrototype.setName(this.name);
        concretePrototype.setHobbies(this.hobbies);
        return concretePrototype;
    }

    @Override
    public String toString() {
        return "ConcretePrototype{" +
                "age=" + age +
                ", name='" + name + '\'' +
                ", hobbies=" + hobbies +
                '}';
    }
}
```
### SETTERæ–¹æ³•å®ç°æµ…å…‹éš†
<img src="https://xcu-oss.oss-cn-beijing.aliyuncs.com/image/gao/up-569ebf8ef5519ace6b434b1301d87165f2c.png" style="zoom:50%;" />

> æµ…å…‹éš†ä¹Ÿå«æµ…æ‹·è´ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ–°å¯¹è±¡çš„å±æ€§å’ŒåŸæ¥å¯¹è±¡å®Œå…¨ç›¸åŒï¼Œå¯¹äºéåŸºæœ¬ç±»å‹å±æ€§ï¼Œä»æŒ‡å‘åŸæœ‰å±æ€§æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚  
```java
public static void main(String[] args) {
        //åˆ›å»ºåŸå‹å¯¹è±¡
        ConcretePrototype1 prototype = new ConcretePrototype1();
        prototype.setAge(18);
        prototype.setName("Tom");
        ArrayList<String> strings = Lists.newArrayList("æ•°å­¦", "è‹±è¯­");
        prototype.setHobbies(strings);
        System.out.println(prototype);

        //æ‹·è´åŸå‹å¯¹è±¡
        ConcretePrototype1 cloneType = prototype.clone();
        cloneType.getHobbies().add("è¯­æ–‡");
        System.out.println(cloneType);
        System.out.println(prototype);
        System.err.println(cloneType == prototype);
        System.err.println(cloneType.getHobbies() == prototype.getHobbies());
    }
è¾“å‡ºç»“æœï¼š
ConcretePrototype1{age=18, name='Tom', hobbies=[æ•°å­¦, è‹±è¯­]}
ConcretePrototype1{age=18, name='Tom', hobbies=[æ•°å­¦, è‹±è¯­, è¯­æ–‡]}
ConcretePrototype1{age=18, name='Tom', hobbies=[æ•°å­¦, è‹±è¯­, è¯­æ–‡]}
false
// è¿™é‡Œä¸ºä»€ä¹ˆç»“æœæ˜¯trueçœ‹åˆ°ä¸Šé¢ç”»çš„å›¾åº”è¯¥å¯ä»¥çœ‹æ‡‚å§ï¼Œsetæ–¹æ³•å…¶å®æ˜¯å°†listçš„å¼•ç”¨è®¾ç½®è¿‡å»ï¼Œå¹¶ä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„listå†èµ‹å€¼ï¼
true
```

## é€šè¿‡å†…å­˜å­—èŠ‚æµ"å…‹éš†"å¯¹è±¡ï¼Œå®ç°æ·±å…‹éš†
<img src="https://xcu-oss.oss-cn-beijing.aliyuncs.com/image/gao/up-41df4d66a80f2d0c2bfd87b7fea52ca9ddd.png" style="zoom:50%;" />

> æ·±å…‹éš†ä¹Ÿå«æ·±æ‹·è´ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå±æ€§ä¸­å¼•ç”¨çš„å…¶ä»–å¯¹è±¡ä¹Ÿä¼šè¢«å…‹éš†ï¼Œä¸å†æŒ‡å‘åŸæœ‰å¯¹è±¡åœ°å€ã€‚
```java
public class ConcretePrototypeDeep implements Cloneable,Serializable {

    private int age;
    private String name;
    private List<String> hobbies;

    public List<String> getHobbies() {
        return hobbies;
    }

    public void setHobbies(List<String> hobbies) {
        this.hobbies = hobbies;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    // åŸºäºå†…å­˜å­—èŠ‚æµç”Ÿæˆå¯¹è±¡
    public ConcretePrototypeDeep deepClone() {
        try {
            //å°†å½“å‰å¯¹è±¡ä¿¡æ¯å†™åˆ°å†…å­˜
            ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
            ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
            objectOutputStream.writeObject(this);
            //ä»å†…å­˜ä¸­è¯»å–å¯¹è±¡ä¿¡æ¯ï¼Œå¼ºåˆ¶è½¬æ¢æˆå½“å‰ç±»å‹
            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());
            ObjectInputStream objectInputStream = new ObjectInputStream(byteArrayInputStream);
            return (ConcretePrototypeDeep) objectInputStream.readObject();
        } catch (IOException ioException) {
            ioException.printStackTrace();
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
        return null;
    }


    @Override
    public String toString() {
        return "ConcretePrototype{" +
                "age=" + age +
                ", name='" + name + '\'' +
                ", hobbies=" + hobbies +
                '}';
    }
}
```
è¾“å‡ºç»“æœï¼š  
```java
ConcretePrototype{age=18, name='Tom', hobbies=[æ•°å­¦, è‹±è¯­]}
ConcretePrototype{age=18, name='Tom', hobbies=[æ•°å­¦, è‹±è¯­, è¯­æ–‡]}
ConcretePrototype{age=18, name='Tom', hobbies=[æ•°å­¦, è‹±è¯­]}
false
false
```

åœ¨Javaè¯­è¨€ä¸­ï¼Œå¦‚æœéœ€è¦å®ç°æ·±å…‹éš†ï¼Œå¯ä»¥é€šè¿‡è¦†ç›–Objectç±»çš„clone()æ–¹æ³•å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åºåˆ—åŒ–(Serialization)ç­‰æ–¹å¼æ¥å®ç°ã€‚
> è¦å®ç°æ·±æ‹·è´ï¼Œå¿…é¡»å®ç°Cloneableæ¥å£ï¼Œå»é‡å†™cloneæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡ºCloneNotSupportedExceptionå¼‚å¸¸ï¼Œ
> ä½†æ˜¯å¦‚æœå¯¹è±¡ä¸­åŒ…å«å¾ˆå¤šå¼•ç”¨ç±»å‹çš„å±æ€§ï¼Œè¿™æ ·å»è¦†ç›–cloneæ–¹æ³•å…¶å®æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨åºåˆ—åŒ–çš„æ–¹å¼å®ç°ï¼    


## å…‹éš†ç ´åå•ä¾‹æ¨¡å¼
å¦‚æœæˆ‘ä»¬å…‹éš†çš„ç›®æ ‡çš„å¯¹è±¡æ˜¯å•ä¾‹å¯¹è±¡ï¼Œè¿™ä¾¿æ„å‘³ç€ï¼Œæ·±å…‹éš†ä¼šç ´åå•ä¾‹ã€‚è§£å†³ä»¥ä¸Šé—®é¢˜çš„æ€è·¯ï¼š
- **ç¦æ­¢æ·±å…‹éš†**
- **åœ¨å•ä¾‹å¯¹è±¡çš„getInstanceæ–¹æ³•ï¼Œè¿”å›å½“å‰å¯¹è±¡ï¼Œè€Œä¸æ˜¯å»æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡æˆ–è€…é€šè¿‡å†…å­˜å­—èŠ‚æµç­‰æ–¹æ³•ç”Ÿæˆå¯¹è±¡**


## åŸå‹æ¨¡å¼åœ¨Javaä¸­çš„åº”ç”¨
ArrayListåº•å±‚æ˜¯åŸºäºæ•°ç»„ç»“æœçš„ï¼Œå®ƒçš„åŠ¨æ€æ‰©å®¹è¿‡ç¨‹æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå¹¶æŠŠæ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´è¿‡å»ï¼Œç”¨æ–°çš„æ•°ç»„æ¥ç»§ç»­å­˜æ”¾å…ƒç´ ï¼›
åœ¨åˆ›å»ºæ–°æ•°ç»„çš„è¿‡ç¨‹ä¸­ä¾¿ä½¿ç”¨äº†åŸå‹æ¨¡å¼ã€‚
### java.util.ArrayList.clone
```java
    public Object clone() {
        try {
            ArrayList<?> v = (ArrayList<?>) super.clone();
            v.elementData = Arrays.copyOf(elementData, size);
            v.modCount = 0;
            return v;
        } catch (CloneNotSupportedException e) {
            // this shouldn't happen, since we are Cloneable
            throw new InternalError(e);
        }
    }
```
### java.util.Arrays.copyOf(T[], int)
```java
 public static <T> T[] copyOf(T[] original, int newLength) {
        return (T[]) copyOf(original, newLength, original.getClass());
    }
```
### java.util.Arrays.copyOf(U[], int, java.lang.Class<? extends T[]>)
```java
public static <T,U> T[] copyOf(U[] original, int newLength, Class<? extends T[]> newType) {
        @SuppressWarnings("unchecked")
        T[] copy = ((Object)newType == (Object)Object[].class)
            ? (T[]) new Object[newLength]
            : (T[]) Array.newInstance(newType.getComponentType(), newLength);
        System.arraycopy(original, 0, copy, 0,
                         Math.min(original.length, newLength));
        return copy;
    }
```
æœ€ç»ˆè¿˜æ˜¯System.arraycopy(original, 0, copy, 0,
                             Math.min(original.length, newLength));è¿™ä¸ªæ–¹æ³•æ¥å®Œæˆæ•°ç»„çš„æ‹·è´ï¼
åƒæˆ‘ä»¬ä½¿ç”¨çš„ 

`com.alibaba.fastjson.JSON#parseObject`

org.springframework.beans.BeanUtils#copyProperties(java.lang.Object, java.lang.Object)`

ç­‰éƒ½æ˜¯åŸå‹æ¨¡å¼ï¼›


## åŸå‹æ¨¡å¼é€‚ç”¨åœºæ™¯

- **ç±»åˆå§‹åŒ–æ¶ˆè€—èµ„æºè¿‡å¤š**  
- **newä¸€ä¸ªå¯¹è±¡éœ€è¦å¾ˆå¤šç¹ççš„è¿‡ç¨‹ï¼ˆæ•°æ®å‡†å¤‡ï¼Œè®¿é—®æƒé™ç­‰ï¼‰**  
- **æ„é€ å‡½æ•°æ¯”è¾ƒå¤æ‚**
- **å¾ªç¯ä½“å†…äº§ç”Ÿå¤§é‡å¯¹è±¡æ—¶**

## åŸå‹æ¨¡å¼çš„ä¼˜ç‚¹
- **Javaè‡ªå¸¦çš„åŸå‹æ¨¡å¼æ˜¯åŸºäºå†…å­˜äºŒè¿›åˆ¶æµçš„å¤åˆ¶ï¼Œåœ¨æ€§èƒ½ä¸Šæ¯”ç›´æ¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ›´åŠ ä¼˜è‰¯**
- **å¯ä»¥ä½¿ç”¨æ·±å…‹éš†çš„æ–¹å¼ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ï¼Œä½¿ç”¨åŸå‹æ¨¡å¼å°†å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å°†å…¶çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œç®€åŒ–äº†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼Œ
ä»¥ä¾¿åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨ï¼Œå¯è¾…åŠ©å®ç°æ’¤é”€æ“ä½œã€‚**

##  åŸå‹æ¨¡å¼çš„ç¼ºç‚¹
- **éœ€è¦ä¸ºæ¯ä¸€ä¸ªç±»éƒ½é…ç½®ä¸€ä¸ª clone æ–¹æ³•**
- **clone æ–¹æ³•ä½äºç±»çš„å†…éƒ¨ï¼Œå½“å¯¹å·²æœ‰ç±»è¿›è¡Œæ”¹é€ çš„æ—¶å€™ï¼Œéœ€è¦ä¿®æ”¹ä»£ç ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™**
- **å½“å®ç°æ·±å…‹éš†æ—¶ï¼Œéœ€è¦ç¼–å†™è¾ƒä¸ºå¤æ‚çš„ä»£ç ï¼Œè€Œä¸”å½“å¯¹è±¡ä¹‹é—´å­˜åœ¨å¤šé‡åµŒå¥—å¼•ç”¨æ—¶ï¼Œä¸ºäº†å®ç°æ·±å…‹éš†ï¼Œæ¯ä¸€å±‚å¯¹è±¡å¯¹åº”çš„ç±»éƒ½å¿…é¡»æ”¯æŒæ·±å…‹éš†ï¼Œ
å®ç°èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œæ·±å…‹éš†ã€æµ…å…‹éš†éœ€è¦è¿ç”¨å¾—å½“**

