---
title: è®¾è®¡æ¨¡å¼ä¹‹ç¾-è´£ä»»é“¾æ¨¡å¼
toc: true
date: 2021-08-07 20:21:01
tags: è®¾è®¡æ¨¡å¼
categories:
---

# è´£ä»»é“¾æ¨¡å¼

è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patterï¼‰æ˜¯å°†é“¾ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¤„ç†çš„è¯·æ±‚å‡ä¸ç›¸åŒï¼Œ
å¹¶ä¸”å†…éƒ¨è‡ªåŠ¨ç»´æŠ¤ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡ã€‚å½“ä¸€ä¸ªè¯·æ±‚ä»é“¾çš„å¤´éƒ¨å‘å‡ºæ—¶ï¼Œä¼šæ²¿ç€é“¾çš„è·¯å¾„ä¸€æ¬¡ä¼ é€’ç»™æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡ï¼Œç›´åˆ°æœ‰èŠ‚ç‚¹å¤„ç†è¿™ä¸ªè¯·æ±‚ä¸ºæ­¢ï¼›è´£ä»»é“¾æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼

## ç±»å›¾
<img src="https://xcu-oss.oss-cn-beijing.aliyuncs.com/image/gao/up-346d95211f8ced1530fe1098a480a35a535.png" style="zoom:67%;" />  

### Handler è´£ä»»é“¾æŠ½è±¡ç±» é“¾å¼ç»“æ„
```java
public abstract class Handler {

    protected Handler nextHandler;

    public void setNextHandler(Handler nextHandler) {
        this.nextHandler = nextHandler;
    }

    public abstract void handleRequest(String request);
}
```
### ConcreteHandlerA èŠ‚ç‚¹å¯¹è±¡A
```java
public class ConcreteHandlerA extends Handler {

    @Override
    public void handleRequest(String request) {
        if ("reqA".equals(request)) {
            System.err.println(this.getClass().getSimpleName() + "deal this request " + request);
            return;
        }
        if (this.nextHandler != null) {
            this.nextHandler.handleRequest(request);
        }
    }
}

```
### ConcreteHandlerB èŠ‚ç‚¹å¯¹è±¡B
```java
public class ConcreteHandlerB extends Handler {
    @Override
    public void handleRequest(String request) {
        if ("reqB".equals(request)) {
            System.err.println(this.getClass().getSimpleName() + "deal this request " + request);
            return;
        }
        if (this.nextHandler != null) {
            this.nextHandler.handleRequest(request);
        }
    }
}
```
### DemoTest æµ‹è¯•ç±»
```java
public class DemoTest {
    public static void main(String[] args) {
        Handler handlerA = new ConcreteHandlerA();
        Handler handlerB = new ConcreteHandlerB();
        handlerA.setNextHandler(handlerB);
        handlerA.handleRequest("reqB");
    }
}
// è¾“å‡ºç»“æœï¼š
//ConcreteHandlerBdeal this request reqB
```

## ä¸šåŠ¡ 

ä¸‹é¢æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¸šåŠ¡åœºæ™¯çš„ä¾‹å­ğŸŒ°æ¥å±•ç¤ºä¸€ä¸‹ä»€ä¹ˆæ˜¯è´£ä»»é“¾æ¨¡å¼ï¼š
æˆ‘ä»¬ç™»å½•æ—¶ï¼Œè‚¯å®šè¦æ ¡éªŒç”¨æˆ·åå’Œå¯†ç æœ‰æ²¡æœ‰ä¼ å‚ï¼Œå¦‚æœå‚æ•°éƒ½æ˜¯ç©ºçš„è¯ï¼Œé‚£ä¹Ÿæ²¡æœ‰å¿…è¦æ‰§è¡Œåé¢çš„ç™»å½•éƒ¨åˆ†ï¼Œç›´æ¥è¿”å›äº†ï¼›å¦‚æœå‚æ•°æ˜¯åˆæ³•çš„ï¼Œé‚£æˆ‘ä»¬å°±è¦æ ¡éªŒæ•°æ®åº“æ˜¯å¦å­˜åœ¨è¿™ä¸ªç”¨æˆ·äº†ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œé‚£å°±ç›´æ¥è¿”å›ï¼›å¦‚æœå­˜åœ¨ï¼Œé‚£å°±è¦æ ¡éªŒç”¨æˆ·æœ‰æ²¡æœ‰æƒé™è®¿é—®æ­£åœ¨è¯·æ±‚çš„èµ„æºï¼Œå¦‚æœæœ‰æƒé™ï¼Œåˆ™å¯ä»¥æ­£å¸¸è®¿é—®èµ„æºï¼Œå¦‚æœæ²¡æœ‰æƒé™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼›  

### éè´£ä»»é“¾æ¨¡å¼å†™æ³•
```java
// ä»¥ä¸‹æ˜¯ä¼ªä»£ç 
public void login(String userName,String pwd){
        if (StringUtils.isEmpty(userName) || StringUtils.isEmpty(pwd)){
            throw new IllegalArgumentException();
        }
        
        Member member = selectUser(userName,pwd);
        if (Objects.isNull(member)){
            throw new IllegalArgumentException();
        }
        
        if (!validateRoot(member)){
            throw new IllegalArgumentException();
        }
        System.err.println("Login success!");
    }
```

è¿™ç§å†™æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å°†æ‰€æœ‰çš„æ“ä½œå…¨éƒ¨æ‚ç³…åœ¨ä¸€èµ·äº†ï¼Œç»“æ„æ˜¯ååˆ†æ··ä¹±çš„ï¼›
ä¸‹é¢ğŸ‘‡çœ‹ä¸€ä¸‹å¦‚æœä½¿ç”¨è´£ä»»é“¾æ¨¡å¼è¯¥å¦‚ä½•å®ç°ï¼š
<img src="https://xcu-oss.oss-cn-beijing.aliyuncs.com/image/gao/up-f94e4e83f493d7a998e1e8bbb36f3c8eb4b.png" style="zoom:67%;" /> 

### Handler æŠ½è±¡è´£ä»»é“¾å¤„ç†å™¨
```java
public abstract class Handler {

   protected Handler next;

   public void next(Handler next){
       this.next = next;
   }

   public abstract void doHandler(Member member);
}
```
### ValidateHandler å‚æ•°æ ¡éªŒå¤„ç†å™¨
```java
public class ValidateHandler extends Handler{
    @Override
    public void doHandler(Member member) {
        if (StringUtils.isEmpty(member.getLoginName()) || StringUtils.isEmpty(member.getLoginPass())){
            System.err.println("ç™»å½•åæˆ–è€…å¯†ç ä¸ºç©ºï¼");
            return;
        }
        System.err.println("å‚æ•°æ ¡éªŒæˆåŠŸï¼");
        next.doHandler(member);
    }
}
```
### ç™»å½•å¤„ç†å™¨
```java
public class LoginHandler extends Handler {
    @Override
    public void doHandler(Member member) {
        System.err.println("login success!");
        member.setRoleName("root");
        next.doHandler(member);
    }
}
```
### é‰´æƒå¤„ç†å™¨
```java
public class AuthHandler extends Handler{
    @Override
    public void doHandler(Member member) {
        if ("root".equals(member.getRoleName())){
            System.err.println("Auth success!");
            return;
        }
        System.err.println("Auth failed!");
    }
}
```
### Memberæˆå‘˜ç±»
```java
public class Member {

    private String loginName;
    private String loginPass;
    private String roleName;

     public Member(String loginName, String loginPass) {
            this.loginName = loginName;
            this.loginPass = loginPass;
     }

    // GETTER SETTER ....
}
```

### DemoTest æµ‹è¯•ç±»
```java
public class DemoTest {
    // é¦–å…ˆåˆ›å»ºæ‰€æœ‰çš„å¤„ç†å™¨ï¼Œè®¾ç½®åå®ƒä»¬çš„å…ˆåé¡ºåºï¼Œè®¾ç½®nextèŠ‚ç‚¹ï¼Œå®Œæˆä¹‹ååœ¨æ‰§è¡Œé“¾è·¯æ“ä½œï¼›
    public static void main(String[] args) {
        ValidateHandler validateHandler = new ValidateHandler();
        LoginHandler loginHandler = new LoginHandler();
        validateHandler.next(loginHandler);
        AuthHandler authHandler = new AuthHandler();
        loginHandler.next(authHandler);
        Member member = new Member("xiaoming", "222");
        validateHandler.doHandler(member);
    }
}
```
ä¸Šé¢çš„å†™æ³•ï¼Œçœ‹èµ·æ¥æœ‰æ²¡æœ‰æ¯”éè´£ä»»é“¾å†™æ³•è¦Bæ ¼é«˜ä¸€äº›ï¼Œä½†æ˜¯ï¼Œè¿™æ ·æ¯æ¬¡åˆ›å»ºèŠ‚ç‚¹å¯¹è±¡ï¼Œå¥½åƒåˆæ˜¾å¾—ä¸å¤ªçˆ½ï¼Œæœ‰äº›è‡ƒè‚¿çš„æ„æ€ï¼è€Œä¸”è°ƒæ•´èŠ‚ç‚¹ä¹‹é—´çš„é¡ºåºæ—¶ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œå®¹æ˜“æ”¹é”™ï¼ é‚£æˆ‘ä»¬å°±è¿›ä¸€æ­¥ä¼˜åŒ–ä»¥ä¸‹å§ï¼  

## è´£ä»»é“¾æ¨¡å¼+å»ºé€ è€…æ¨¡å¼ ä¼˜åŒ–

### æ·»åŠ å»ºé€ å™¨builder 
```java
public abstract class Handler<T> {

    protected Handler next;

    public void next(Handler next) {
        this.next = next;
    }

    public abstract void doHandler(Member member);
    
    // æš´éœ²å»ºé€ å™¨ï¼Œå°†èŠ‚ç‚¹å¯¹è±¡ä»¥é“¾è¡¨çš„å½¢å¼ä¸²èµ·æ¥
    public static class Builder<T> {
        private Handler<T> head;
        private Handler<T> tail;

        public Handler<T> build() {
            return this.head;
        }

        public Builder<T> addHandler(Handler<T> handler) {
            if (this.head == null) {
                this.head = this.tail = handler;
                return this;
            }

            this.tail.next(handler);
            this.tail = handler;
            return this;
        }
    }
}
```
### æµ‹è¯• 
```java
public static void main(String[] args) {
        Member member = new Member("xiaoming", null);
        Handler.Builder<Handler> builder = new Handler.Builder();
        builder.addHandler(new ValidateHandler())
                .addHandler(new LoginHandler())
                .addHandler(new AuthHandler())
                .build()
        .doHandler(member);
    }
```
é€šè¿‡æ·»åŠ å»ºé€ å™¨ä¹‹åï¼Œè´£ä»»é“¾çš„ç»„è£…ä¸è°ƒç”¨æ˜¯ä¸æ˜¯æ˜¾å¾—å¾ˆæ¸…æ™°ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯¹è±¡å„å¸å…¶èŒï¼Œå¦‚æœéœ€è¦æœ¬èŠ‚ç‚¹æ‰§è¡Œï¼Œåˆ™æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™äº¤ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç»§ç»­ï¼  

## è´£ä»»é“¾é€‚ç”¨çš„åœºæ™¯
- **å¤šä¸ªå¯¹è±¡å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œä½†å…·ä½“ç”±é‚£ä¸ªå¯¹è±¡å¤„ç†åˆ™åœ¨è¿åŠ¨æ—¶åŠ¨æ€å†³å®š**
- **åœ¨ä¸æ˜ç¡®ğŸˆ¯æŒ‡å®šæ¥å—è€…çš„æƒ…å†µä¸‹ï¼Œå‘å¤šä¸ªå¯¹è±¡çš„ä¸€ä¸ªæäº¤è¯·æ±‚**
- **å¯ä»¥åŠ¨æ€æŒ‡å®šä¸€ç»„å¯¹è±¡å¤„ç†è¯·æ±‚**

> ä¸¾ä¸€äº›å®é™…çš„ä¾‹å­ï¼š  
> javax.servlet.Filterçš„doFilteræ–¹æ³•å°±æ˜¯ä½¿ç”¨çš„è´£ä»»é“¾æ¨¡å¼;

### org.springframework.web.filter.CompositeFilter#doFilter
```java
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        (new CompositeFilter.VirtualFilterChain(chain, this.filters)).doFilter(request, response);
    }
```
è¿™æ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªå®ç°(javax.servlet.Filter),ä¸‹é¢å±•å¼€å…·ä½“çš„ä»£ç ï¼š
### org.springframework.web.filter.CompositeFilter  
```java
public class CompositeFilter implements Filter {
    //Filter è¿™é‡Œçš„Filterç›¸å½“äºå¤„ç†èŠ‚ç‚¹ï¼Œå­˜æ”¾åœ¨Listä¸­ï¼Œå’Œæˆ‘ä»¬ä¸Šé¢çš„Handlerå­˜æ”¾åœ¨å»ºé€ è€…çš„é“¾å¼ç»“æ„ä¸­ï¼Œå¼‚æ›²åŒå·¥ã€‚
    private List<? extends Filter> filters = new ArrayList();

    public CompositeFilter() {
    }

    public void setFilters(List<? extends Filter> filters) {
        this.filters = new ArrayList(filters);
    }

    public void init(FilterConfig config) throws ServletException {
        Iterator var2 = this.filters.iterator();

        while(var2.hasNext()) {
            Filter filter = (Filter)var2.next();
            filter.init(config);
        }

    }

    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        (new CompositeFilter.VirtualFilterChain(chain, this.filters)).doFilter(request, response);
    }

    public void destroy() {
        int i = this.filters.size();

        while(i-- > 0) {
            Filter filter = (Filter)this.filters.get(i);
            filter.destroy();
        }

    }

    private static class VirtualFilterChain implements FilterChain {
        private final FilterChain originalChain;
        private final List<? extends Filter> additionalFilters;
        private int currentPosition = 0;

        public VirtualFilterChain(FilterChain chain, List<? extends Filter> additionalFilters) {
            this.originalChain = chain;
            this.additionalFilters = additionalFilters;
        }

        public void doFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
            if (this.currentPosition == this.additionalFilters.size()) {
                this.originalChain.doFilter(request, response);
            // é€šè¿‡currentPositionçš„ç§»åŠ¨ï¼Œè½¬ç§»åˆ°é“¾è·¯ä¸Šçš„ä¸åŒå¤„ç†èŠ‚ç‚¹ï¼Œè¿™å°±æ˜¯è´£ä»»é“¾æ¨¡å¼çš„ä½“ç°
            } else {
                ++this.currentPosition;
                Filter nextFilter = (Filter)this.additionalFilters.get(this.currentPosition - 1);
                nextFilter.doFilter(request, response, this);
            }

        }
    }
}
```
åƒä¸Šé¢çš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šï¼Œæ¯”å¦‚Spring Securityå’ŒShiroä¸­çš„æ‹¦æˆªå™¨å°±æ˜¯å¾ˆå…¸å‹çš„è´£ä»»é“¾æ¨¡å¼ï¼Œè¿˜æœ‰Nettyä¸­çš„ io.netty.channel.ChannelPipelineç­‰ç­‰ï¼Œéƒ½æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼›  

## è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ğŸ‘ğŸ‘ğŸ‘
- **å°†è¯·æ±‚ä¸å¤„ç†è§£è€¦**
- **è¯·æ±‚å¤„ç†è€…ï¼ˆèŠ‚ç‚¹å¯¹è±¡ï¼‰åªéœ€è¦å…³æ³¨è‡ªå·±æ„Ÿå…´è¶£çš„è¯·æ±‚è¿›è¡Œå¤„ç†å³å¯ï¼Œå¯¹äºä¸æ„Ÿå…´è¶£çš„è¯·æ±‚ï¼Œç›´æ¥è½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡**
- **å…·å¤‡é“¾å¼ä¼ é€’å¤„ç†è¯·æ±‚åŠŸèƒ½ï¼Œè¯·æ±‚å‘é€è€…æ— éœ€çŸ¥æ™“é“¾è·¯ç»“æ„ï¼Œåªéœ€ç­‰å¾…å¤„ç†è¯·æ±‚ç»“æœ**
- **é“¾è·¯ç»“æ„çµæ´»ï¼Œå¯ä»¥é€šè¿‡æ”¹å˜é“¾è·¯ç»“æœåŠ¨æ€çš„æ–°å¢å’Œåˆ é™¤è´£ä»»**
- **æ˜“äºæ‰©å±•æ–°çš„è¯·æ±‚èŠ‚ç‚¹ï¼ˆç¬¦åˆå¼€é—­åŸåˆ™ï¼‰**


## è´£ä»»é“¾æ¨¡å¼çš„ç¼ºç‚¹
- **è´£ä»»é“¾å¤ªé•¿æˆ–è€…å¤„ç†æ—¶é—´å¤ªé•¿ï¼Œå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™**
- **å¦‚æœèŠ‚ç‚¹å¯¹è±¡å­˜åœ¨å¾ªç¯â™»ï¸å¼•ç”¨æ—¶ï¼Œä¼šé€ æˆæ­»å¾ªç¯ï¼Œå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæ‰€ä»¥è¿™ä¸ªåœ¨è®¾è®¡çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ä¸èƒ½å½¢æˆé—­ç¯âš ï¸âš ï¸âš ï¸**

