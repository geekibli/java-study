---
title: è®¾è®¡æ¨¡å¼ä¹‹ç¾-äº«å…ƒæ¨¡å¼
toc: true
date: 2021-08-07 19:16:35
tags: è®¾è®¡æ¨¡å¼
categories:
---

# äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Patternï¼‰

## å‰è¨€
åœ¨é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶ä¼šé¢ä¸´è¦åˆ›å»ºå¤§é‡ç›¸åŒæˆ–ç›¸ä¼¼å¯¹è±¡å®ä¾‹çš„é—®é¢˜ã€‚åˆ›å»ºé‚£ä¹ˆå¤šçš„å¯¹è±¡å°†ä¼šè€—è´¹å¾ˆå¤šçš„ç³»ç»Ÿèµ„æºï¼Œå®ƒæ˜¯ç³»ç»Ÿæ€§èƒ½æé«˜çš„ä¸€ä¸ªç“¶é¢ˆã€‚  

## å®šä¹‰
äº«å…ƒæ¨¡å¼ï¼Œåˆç§°ä¸ºè½»é‡çº§æ¨¡å¼ï¼Œè¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚å®ƒé€šè¿‡å…±äº«å·²ç»å­˜åœ¨çš„å¯¹è±¡æ¥å¤§å¹…åº¦å‡å°‘éœ€è¦åˆ›å»ºçš„å¯¹è±¡æ•°é‡ã€
é¿å…å¤§é‡ç›¸ä¼¼ç±»çš„å¼€é”€ï¼Œä»è€Œæé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡ã€‚å®ƒæ˜¯å¯¹è±¡æ± çš„ä¸€ç§å®ç°ï¼Œç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± å¯ä»¥é¿å…ä¸åœçš„åˆ›å»ºä¸ªé”€æ¯å¤šä¸ªå¯¹è±¡ï¼Œæ¶ˆè€—æ€§èƒ½ï¼ˆç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼‰ï¼›      
**ã€å®—æ—¨ã€‘**ï¼šå…±äº«ç»†ç²’åº¦å¯¹è±¡ï¼Œå°†å¤šä¸ªå¯¹åŒä¸€å¯¹è±¡çš„è®¿é—®é›†ä¸­èµ·æ¥ï¼›å±äºç»“æ„æ€§æ¨¡å¼ï¼›       

## å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€  
åœ¨å…±äº«å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œåˆä¸¤ç§çŠ¶æ€ï¼š    
**å†…éƒ¨çŠ¶æ€ï¼š** å†…éƒ¨çŠ¶æ€æŒ‡å¯¹è±¡å…±äº«å‡ºæ¥çš„ä¿¡æ¯ï¼Œå­˜å‚¨åœ¨äº«å…ƒä¿¡æ¯å†…éƒ¨ï¼Œå¹¶ä¸”ä¸å›éšç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜ï¼›  
> å°±æ˜¯å¯¹è±¡æ‰€å…±æœ‰çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç«è½¦ç¥¨ï¼Œå¤šæœ‰ä»åŒ—äº¬-ä¸Šæµ·çš„å¯¹è±¡å¯ä»¥å…±ç”¨ä¸€ä¸ªï¼Œè€Œä¸æ˜¯æœ‰1000å¼ ç¥¨ï¼Œåˆ›å»º1000ä¸ªå¯¹è±¡ï¼›    

**å¤–éƒ¨çŠ¶æ€ï¼š** å¤–éƒ¨çŠ¶æ€æŒ‡å¯¹è±¡å¾—ä»¥ä¾èµ–çš„ä¸€ä¸ªæ ‡è®°ï¼Œéšç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜ï¼Œä¸å¯å…±äº«ï¼›  
> ä¹Ÿæ˜¯ä¸å«å¥½ç†è§£çš„ï¼Œå½“ç«è½¦ç¥¨è¢«ä½ è´­ä¹°ä¹‹åï¼Œå°±å’Œä½ çš„èº«ä»½è¯å·ï¼ˆå”¯ä¸€ï¼‰ç»‘å®šäº†ï¼Œè¿™å±äºå¤–éƒ¨çŠ¶æ€ï¼›    

## ä½¿ç”¨åœºæ™¯
1ã€å¸¸å¸¸åº”ç”¨äºç³»ç»Ÿåº•å±‚çš„å¼€å‘ï¼Œä»¥ä¾¿è§£å†³ç³»ç»Ÿçš„æ€§èƒ½é—®é¢˜ï¼›    
2ã€ç³»ç»Ÿæœ‰å¤§é‡ç›¸ä¼¼å¯¹è±¡ï¼Œéœ€è¦ç¼“å†²æ± çš„åœ°æ–¹ï¼›  

## ä¸¾ä¸ªä¾‹å­ğŸŒ°

### äº«å…ƒå®ä½“ç±»
```java
public class Examination {
    private String name;

    private String phone;

    private String subject;

    public Examination(String subject) {
        super();
        this.subject = subject;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    @Override
    public String toString() {
        return "Examination [name=" + name + ", phone=" + phone + ", subject=" + subject + "]";
    }
}
```
### äº«å…ƒå·¥å‚
```java
public class ExaminationFactory {
    // å¯¹è±¡æ± 
    private static Map<String, Examination> pool = new HashMap<>();

    public static Examination getexExamination(String name, String phone, String subject) {
        // é€šè¿‡å­¦ç§‘åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªå¯¹è±¡
        if (pool.containsKey(subject)) {
            Examination examination = pool.get(subject);
            examination.setName(name);
            examination.setPhone(phone);
            System.out.println("åœ¨ç¼“å­˜æ± å–ç”¨å¯¹è±¡:" + examination.toString());
            return examination;
        } else {
            Examination examination = new Examination(subject);
            pool.put(subject, examination);
            examination.setName(name);
            examination.setPhone(phone);
            System.out.println("æ–°å»ºå¯¹è±¡:" + examination.toString());
            return examination;
        }
    }

}
```
### æµ‹è¯•ç±»
```java
public class Client {
    public static void main(String[] args) {
        Examination A = ExaminationFactory.getexExamination("A", "13812345678", "è½¯ä»¶å·¥ç¨‹");
        Examination B = ExaminationFactory.getexExamination("B", "13812341234", "è½¯ä»¶å·¥ç¨‹");
        Examination C = ExaminationFactory.getexExamination("C", "13812341328", "ç”µå­ä¿¡æ¯å·¥ç¨‹");
        Examination D = ExaminationFactory.getexExamination("D", "13812345111", "æ¡¥æ¢å·¥ç¨‹å·¥ç¨‹");
        Examination E = ExaminationFactory.getexExamination("E", "13812345444", "è½¯ä»¶å·¥ç¨‹");

        System.err.println(A.hashCode());
        System.err.println(B.hashCode());
    }
}
```
### æµ‹è¯•ç»“æœ
```java
æ–°å»ºå¯¹è±¡:Examination [name=A, phone=13812345678, subject=è½¯ä»¶å·¥ç¨‹]
åœ¨ç¼“å­˜æ± å–ç”¨å¯¹è±¡:Examination [name=B, phone=13812341234, subject=è½¯ä»¶å·¥ç¨‹]
æ–°å»ºå¯¹è±¡:Examination [name=C, phone=13812341328, subject=ç”µå­ä¿¡æ¯å·¥ç¨‹]
æ–°å»ºå¯¹è±¡:Examination [name=D, phone=13812345111, subject=æ¡¥æ¢å·¥ç¨‹å·¥ç¨‹]
åœ¨ç¼“å­˜æ± å–ç”¨å¯¹è±¡:Examination [name=E, phone=13812345444, subject=è½¯ä»¶å·¥ç¨‹]
1528902577
1528902577
```

## å®é™…åº”ç”¨
1ã€JDK -- String  
```java
  public static void main(String[] args) {
    		// "hello"æ˜¯ç¼–è¯‘å™¨å¸¸é‡ï¼Œ String s1æ˜¯è¿è¡Œæ—¶ï¼ŒæŠŠå¸¸é‡åœ°å€èµ‹å€¼ç»™ä»–<br>
        String s1 = "hello";
        String s2 = "hello";
		    // "he" + "llo" ä¸¤ä¸ªå¸¸é‡ç›¸åŠ ï¼Œä¼šåœ¨ç¼–è¯‘æœŸå¤„ç†<br>
        String s3 = "he" + "llo"; 
		    // "hel" "lo" new String å…±å»ºäº†3ä¸ªç©ºé—´ï¼Œç„¶åæ‹¼æ¥èµ·æ¥æ˜¯ä¸€ä¸ªæ–°çš„ç©ºé—´ï¼ˆwhy?ï¼‰
        String s4 = "hel" + new String("lo"); 
        String s5 = new String("hello"); // s5å­˜æ”¾çš„æ˜¯å †ä¸­ä¸­é—´
        String s6 = s5.intern();  //æ‹¿åˆ°å¸¸é‡ä¸­çš„åœ°å€ï¼Œ
        String s7 = "h";
        String s8 = "ello";
        String s9 = s7 + s8; //ä¸ºä»€ä¹ˆè¿™ä¸ªä¸ä¸€æ ·ï¼Œå› ä¸ºæ˜¯å˜é‡ç›¸åŠ æ‰€ä»¥ç¼–è¯‘æœŸæ²¡æœ‰åšä¼˜åŒ–

        System.out.println(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
        System.out.println("s1 " + System.identityHashCode(s1));
        System.out.println("s2 " + System.identityHashCode(s2));
        System.out.println("s3 " + System.identityHashCode(s3));
        System.out.println("s4 " + System.identityHashCode(s4));
        System.out.println("s5 " + System.identityHashCode(s5));
     		//s6ä¸ºs5.intern()æ‹¿åˆ°çš„æ˜¯å¸¸é‡æ± é‡Œçš„â€œhelloâ€
        System.out.println("s6 " + System.identityHashCode(s6));
        System.out.println("s7 " + System.identityHashCode(s7));
        System.out.println("s8 " + System.identityHashCode(s8));
        System.out.println("s9 " + System.identityHashCode(s9));
        System.out.print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>");
        System.out.println(s1==s2);//true
        System.out.println(s1==s3);//true
        System.out.println(s1==s4);//false
        System.out.println(s1==s9);//false
        System.out.println(s4==s5);//false
        System.out.println(s1==s6);//true
    }
```

<img src="https://xcu-oss.oss-cn-beijing.aliyuncs.com/image/gao/7689e9454c9140819c515317ba2f3da8~tplv-k3u1fbpfcp-zoom-1.image" style="zoom:50%;" />  

2ã€JDK -- Integer  
```java
private static class IntegerCache {
        static final int low = -128;
        static final int high;
        static final Integer cache[];

        static {
            // high value may be configured by property
            int h = 127;
            String integerCacheHighPropValue =
                sun.misc.VM.getSavedProperty("java.lang.Integer.IntegerCache.high");
            if (integerCacheHighPropValue != null) {
                try {
                    int i = parseInt(integerCacheHighPropValue);
                    i = Math.max(i, 127);
                    // Maximum array size is Integer.MAX_VALUE
                    h = Math.min(i, Integer.MAX_VALUE - (-low) -1);
                } catch( NumberFormatException nfe) {
                    // If the property cannot be parsed into an int, ignore it.
                }
            }
            high = h;

            cache = new Integer[(high - low) + 1];
            int j = low;
            for(int k = 0; k < cache.length; k++)
                cache[k] = new Integer(j++);

            // range [-128, 127] must be interned (JLS7 5.1.7)
            assert IntegerCache.high >= 127;
        }

        private IntegerCache() {}
    }
```
3ã€çº¿ç¨‹æ±   
4ã€Tomcatè¿æ¥æ±   


## äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹âœ…
1ã€å‡å°‘å¯¹è±¡çš„åˆ›å»ºï¼Œé™ä½å†…å­˜ä¸­å¯¹è±¡çš„æ•°é‡ï¼Œé™ä½ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨ï¼Œæå‡æ•ˆç‡ï¼›   
2ã€å‡å°‘å†…å­˜ä¹‹å¤–çš„å…¶ä»–èµ„æºå ç”¨ï¼ŒIO,å¸¦å®½ç­‰ï¼›  

## äº«å…ƒæ¨¡å¼çš„ç¼ºç‚¹
1ã€å…³æ³¨å†…éƒ¨ï¼Œå¤–éƒ¨çŠ¶æ€ï¼Œå…³æ³¨ç¨‹åºçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›  
2ã€ä½¿ç³»ç»Ÿã€ç¨‹åºçš„é€»è¾‘å˜å¾—å¤æ‚ï¼›  

## å‚è€ƒèµ„æ–™ 
1ã€[[è®¾è®¡æ¨¡å¼] - äº«å…ƒæ¨¡å¼](https://juejin.cn/post/6924611630391115783)  
2ã€[è®¾è®¡æ¨¡å¼-äº«å…ƒæ¨¡å¼](https://juejin.cn/post/6914489741706526734)  
3ã€[è®¾è®¡æ¨¡å¼-äº«å…ƒè®¾è®¡æ¨¡å¼](https://juejin.cn/post/6844903841188577288)    
