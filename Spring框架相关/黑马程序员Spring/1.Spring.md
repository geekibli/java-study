




## 1.BeanFactoryå’ŒApplicationContext


### 1.1 åˆ°åº•ä»€ä¹ˆæ˜¯BeanFactory

1. å®ƒæ˜¯ApplicationContextçš„çˆ¶æ¥å£
2. å®ƒæ‰æ˜¯Springçš„æ ¸å¿ƒå®¹å™¨, ä¸»è¦çš„ApplicationContext å®ç°/ç»„åˆ äº†å®ƒçš„åŠŸèƒ½



### 1.2 BeanFactoryèƒ½åšä»€ä¹ˆ

1. è¡¨é¢ä¸Šåªæœ‰getBean
2. å®é™…ä¸Šæ§åˆ¶åè½¬ã€åŸºæœ¬çš„ä¾èµ–ï¼Œæ³¨å…¥ã€ç›´è‡³Beançš„ç”Ÿå‘½å‘¨æœŸçš„å„ç§åŠŸèƒ½ï¼Œéƒ½ç”±å®ƒçš„å®ç°ç±»æä¾›
3. å®ƒå¯ä»¥ç®¡ç†æ‰€æœ‰çš„bean
	

ä¸‹é¢é€šè¿‡åå°„æ–¹å¼æ‹¿åˆ°beanFactoryä¸­çš„å•ä¾‹beanï¼Œå½“ç„¶æ˜¯é™å®šçš„ä¸€äº›ç±»ï¼š

```java
public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
        ConfigurableApplicationContext context = SpringApplication.run(TestSpringApplication.class, args);

        Field singletonObjects = DefaultSingletonBeanRegistry.class.getDeclaredField("singletonObjects");
        singletonObjects.setAccessible(true);
        ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();
        Map<String, Object> map = (Map<String, Object>) singletonObjects.get(beanFactory);
        map.entrySet().stream().filter(e -> e.getKey().startsWith("component"))
                .forEach(e -> {
                    System.err.println(e.getKey() + "   " + e.getValue());
                });
    }
```

![](https://oscimg.oschina.net/oscnet/up-2817b1229a9ef68d7856a9db4294f3a4bc7.png)


### 1.3 ApplicationContextæ¯”BeanFactoryæ‰©å±•äº†å“ªäº›åŠŸèƒ½


![](https://oscimg.oschina.net/oscnet/up-8f860ac2720e02b1276316a46d70ac586c3.png)


- MessageSource: å›½é™…åŒ–è¯­è¨€æ”¯æŒèƒ½åŠ›
- ResourcePatternResolverï¼šä¸€äº›é€šé…ç¬¦çš„æ”¯æŒèƒ½åŠ›
- ApplicationEventPublisherï¼š äº‹ä»¶å‘å¸ƒèƒ½åŠ›
- EnvironmentCapableï¼š ç¯å¢ƒä¿¡æ¯è¯»å–èƒ½åŠ›ï¼Œç³»ç»Ÿå˜é‡å’Œé…ç½®æ–‡ä»¶


**ä¸‹é¢çœ‹ä¸€ä¸‹MessageSourceèƒ½åŠ›çš„å±•ç¤ºï¼š**

![](https://oscimg.oschina.net/oscnet/up-ad1583066a2d339fab7994f113878c1e447.png)


**contextè·å–èµ„æº**
```java
 Resource[] resources = context.getResources("classpath:application.properties");
        for (Resource resource : resources) {
            System.err.println(resource);
        }

Resource[] resources = context.getResources("classpath*:MATE-INF/spring.factories");
        for (Resource resource : resources) {
            System.err.println(resource);
        }
```
è¾“å‡ºç»“æœ: 
```java
class path resource [application.properties]
```


**contextè·å–ç¯å¢ƒé…ç½®**
```java
System.err.println(context.getEnvironment().getPropertySources().get("java_home"));
System.err.println(context.getEnvironment().getProperty("java_home"));
System.err.println(context.getEnvironment().getProperty("spring.profiles.active"));
```

**äº‹ä»¶å‘å¸ƒä¸ç›‘å¬**
![](https://oscimg.oschina.net/oscnet/up-56692d6e9e11a092596b81ca73312c39030.png)


> **äº‹ä»¶çš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡Œè§£è€¦åˆã€‚**


## 2.å®¹å™¨çš„å®ç°

### 2.1 beançš„å£°æ˜å’Œå®šä¹‰
```java
package com.example.testspring.beans;

import lombok.Data;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.support.AbstractBeanDefinition;
import org.springframework.beans.factory.support.BeanDefinitionBuilder;
import org.springframework.beans.factory.support.DefaultListableBeanFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

public class TestBeanFactory {
    public static void main(String[] args) {
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
        beanFactory.registerBeanDefinition("config", beanDefinition);

        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.out.println("beanDefinitionName : " + beanDefinitionName);
        }
    }

    @Configuration
    static class Config{
        @Bean
        public Bean1 getBean1(){
            return new Bean1();
        }

        @Bean
        public Bean2 getBean2(){
            return new Bean2();
        }
    }

    @Data
    static class Bean1 {

        public Bean1 (){
            System.out.println("init Bean1");
        }

        @Autowired
        private Bean2 bean2;

    }

    @Data
    static class Bean2 {
        public Bean2 (){
            System.out.println("init Bean2");
        }
    }

}

```
**è¾“å‡ºç»“æœï¼š**

```java
beanDefinitionName : config
```

è¿è¡Œä»¥ä¸Šmainæ–¹æ³•ï¼Œå‘ç°åˆæœ‰ä¸€ä¸ªbeanDefinitionï¼Œ**é‚£ä¸ºä»€ä¹ˆBean1 , Bean2 æ²¡æœ‰æ‰“å°å‡ºæ¥å‘¢ï¼Ÿ**


å› ä¸ºåŸå§‹çš„DefaultListableBeanFactoryå¹¶æ²¡æœ‰èƒ½åŠ›å¤„ç†@Beanï¼Œ @Configuration è¿™æ ·çš„æ³¨è§£ï¼Œéœ€è¦å€ŸåŠ©ä¸€ä¸ªå·¥å…·ç±»ï¼š

```java
public static void main(String[] args) {
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
        beanFactory.registerBeanDefinition("config", beanDefinition);

        // ç»™ beanFactory æ·»åŠ ä¸€äº›å¸¸ç”¨çš„åç½®å¤„ç†å™¨
        AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);
        
        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.out.println("beanDefinitionName : " + beanDefinitionName);
        }
    }
```
**è¿è¡Œç»“æœï¼š**
```java
beanDefinitionName : config
beanDefinitionName : org.springframework.context.annotation.internalConfigurationAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalAutowiredAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalCommonAnnotationProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerFactory
```


è¿™é‡Œå¯ä»¥çœ‹åˆ°å¢åŠ äº†ä¸€äº›Springé»˜è®¤çš„beanFactoryåç½®å¤„ç†å™¨ï¼Œæ¯”å¦‚ï¼ŒinternalConfigurationAnnotationProcessorã€‚
è¿™æ˜¯Springå†…ç½®çš„æ³¨è§£é…ç½®ç±»çš„å¤„ç†å™¨ï¼Œç°åœ¨å®ƒæ˜¯å‡ºç°åœ¨äº†BeanFactoryä¸­äº†ï¼Œä½†æ˜¯ç”±äºå®ƒè¿˜æ²¡æœ‰å·¥ä½œï¼Œæ‰€ä»¥ï¼Œæ‰“å°çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬ä¾æ—§çœ‹ä¸åˆ°Bean1,Bean2ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œè¿™äº›åç½®å¤„ç†å™¨çš„åç½®å¤„ç†æ–¹æ³•ï¼š

```java
public static void main(String[] args) {
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
        beanFactory.registerBeanDefinition("config", beanDefinition);

        // ç»™ beanFactory æ·»åŠ ä¸€äº›å¸¸ç”¨çš„åç½®å¤„ç†å™¨
        AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);

        beanFactory.getBeansOfType(BeanFactoryPostProcessor.class)
                .values().stream()
                .forEach(beanFactoryPostProcessor -> {
                    beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);
                });

        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.out.println("beanDefinitionName : " + beanDefinitionName);
        }
    }
```

**é…ç½®ç±»å¦‚ä¸‹ï¼š**  

> è¿™é‡Œè®¾ç½®äº†ä¸€ä¸‹beançš„åå­—

```java
@Configuration
    static class Config{
        @Bean(name = "bean1")
        public Bean1 getBean1(){
            return new Bean1();
        }

        @Bean(name = "bean2")
        public Bean2 getBean2(){
            return new Bean2();
        }
    }
```
å¦‚æœä¸è®¾ç½® `@Bean(name = "bean1")`ï¼Œ æ‰“å°å‡ºæ¥çš„beanDefinitionNameå°±æ˜¯æ–¹æ³•çš„åå­—ã€‚ **getBean1**

**æ‰§è¡Œç»“æœï¼š**
```java
beanDefinitionName : config
beanDefinitionName : org.springframework.context.annotation.internalConfigurationAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalAutowiredAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalCommonAnnotationProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerFactory
beanDefinitionName : bean1
beanDefinitionName : bean2
```

ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒBean1, Bean2æ˜¯æ‰“å°å‡ºæ¥äº†ã€‚


### 2.2 å¦‚ä½•ä½¿ç”¨bean

```java
System.err.println(beanFactory.getBean(Bean1.class).getBean2());
```
**è¿è¡Œç»“æœï¼š**

```java
init Bean1
null
```
å¯ä»¥çœ‹åˆ°ï¼Œbean2çš„å®ä¾‹æ‰“å°ç»“æœæ˜¯ç©ºã€‚ä¸ºä»€ä¹ˆï¼Œ**å¯¹è±¡æ³¨å…¥æ²¡æœ‰ç”Ÿæ•ˆ**ã€‚

éœ€è¦beançš„åç½®å¤„ç†å™¨ `org.springframework.context.annotation.internalAutowiredAnnotationProcessor` æ¥å¤„ç†å¯¹åº”çš„æ–¹æ³•æ¥å¤„ç† @Autowired æ³¨è§£ã€‚

é’ˆå¯¹Beançš„å£°æ˜å‘¨æœŸçš„å„ä¸ªé˜¶æ®µæä¾›æ‰©å±•ï¼Œæ¯”å¦‚ @Autowired, @Resource...

**æŠŠbeanPostProcessoræ·»åŠ åˆ°beanFactoryä¸­**

```java
beanFactory.getBeansOfType(BeanPostProcessor.class).values().forEach(beanFactory::addBeanPostProcessor);

        System.err.println(beanFactory.getBean(Bean1.class).getBean2());
```
**å†æ¬¡æŸ¥çœ‹è¿è¡Œç»“æœï¼š**

```java
21:56:59.269 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean1'
21:56:59.270 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'config'
init Bean1
21:56:59.309 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean2'
init Bean2
TestBeanFactory.Bean2()
```

**æ³¨æ„**ï¼šå•ä¾‹beanå¹¶ä¸æ˜¯beanFactoryä¸€å¼€å§‹å°±éƒ½åˆ›å»ºå¥½çš„ï¼Œè€Œæ˜¯ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæ‰å›å»åˆå§‹åŒ–ã€‚

å¦‚æœéœ€è¦äº‹å…ˆå°±åˆå§‹åŒ–æ‰€æœ‰çš„å•ä¾‹å¯¹è±¡ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªæ–¹æ³•ï¼š

```java
beanFactory.preInstantiateSingletons();
```

### 2.3 beanFactoryå°ç»“

**a. beanFactoryä¸ä¼šä¸»åŠ¨å»åšçš„äº‹**

1. ä¸ä¼šä¸»åŠ¨è°ƒç”¨BeanFactory åç½®å¤„ç†å™¨
2. ä¸ä¼šä¸»åŠ¨æ·»åŠ Benaåç½®å¤„ç†å™¨
3. ä¸ä¼šä¸»åŠ¨åˆå§‹åŒ–å•ä¾‹bean
4. ä¸ä¼šè§£æbeanFactory,è¿˜ä¸ä¼šè§£æ ${} å’Œ #{}


**b. beanFactoryåç½®å¤„ç†å™¨æœ‰æ’åºçš„é€»è¾‘ã€‚**

> beanFactoryå¾ˆå¤šåŸºç¡€çš„åŠŸèƒ½éƒ½æ²¡æœ‰ä¸»åŠ¨å»åšã€‚éœ€è¦æ‰‹åŠ¨å»æŠŠåç½®å¤„ç†å™¨è®¾ç½®å¥½åæ‰å¯ä»¥ä½¿ç”¨ã€‚



### 2.4 beanFactoryæ‰©å±•-åç½®å¤„ç†å™¨é¡ºåº

åç½®å¤„ç†å™¨çš„æ·»åŠ é¡ºåºå¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªæ–¹æ³•çš„æºç  ğŸ‘‡ï¼š

```java
org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object)
```

å¯ä»¥çœ‹åˆ°@Autowiredçš„å¤„ç†å™¨åŠ åœ¨@Resourceçš„æ¢³ç†å™¨å‰é¢ã€‚å­˜å‚¨çš„ç»“æ„æ˜¯ `Set<BeanDefinitionHolder> beanDefs = new LinkedHashSet(8);`

**å¦‚æœä¸€ä¸ªå±æ€§æ³¨å…¥æ˜¯ï¼Œå³æœ‰ @Autowired åˆæœ‰ @Resourceæ³¨è§£ï¼Œä¼šæ€æ ·ï¼Ÿ** ä¸‹é¢å°è¯•ä¸€ä¸‹ï¼š

å¢åŠ ä¸¤ä¸ªbeanï¼ŒåŒæ—¶åŠ åˆ°å®¹å™¨ä¸­ï¼ˆ@Configuration + @Beanï¼‰

```java
 interface Inner {
        
    }
    
@Data
static class Bean3 implements Inner {
    
    public Bean3(){
        System.out.println("init Bean3");
    }
}

@Data
static class Bean4 implements Inner {

    public Bean4(){
        System.out.println("init Bean4");
    }
}
```

å¦‚æœæ³¨å…¥çš„ç±»å‹æ˜¯ `Inner` æ¥å£ç±»å‹ï¼Œä¼šæ€æ ·ï¼Ÿ

![](https://oscimg.oschina.net/oscnet/up-de5c6eb457b97ded607e1f6abbc36af2b4c.png)

ä¼šæœ‰ç¼–è¯‘é”™è¯¯ï¼Œæç¤ºæœ‰2ä¸ªç±»å‹ï¼ŒBean3 å’Œ Bean4ï¼Œæ²¡æœ‰æ˜ç¡®è¦æ³¨å…¥é‚£ä¸ªç±»å‹ã€‚

ä½†æ˜¯å¦‚æœè¦æ˜¯æ”¹ä¸€ä¸‹æ³¨å…¥çš„å˜é‡åç§°å‘¢ï¼Ÿ

```java
 @Data
static class Bean1 {
    public Bean1() {
        System.out.println("init Bean1");
    }
    @Autowired
    private Inner bean3;
}
```
**å¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥æ­£ç¡®æ³¨å…¥çš„ã€‚**

ç”±æ­¤å¯ä»¥çŸ¥é“ @Autowired ä¼˜å…ˆæŒ‰ç…§ç±»å‹æ³¨å…¥ï¼Œå¦‚æœç±»å‹ä¸èƒ½ç¡®å®šå”¯ä¸€ï¼Œéœ€è¦æŒ‡å®šåç§°æ³¨å…¥ã€‚

æˆ–è€…å¯ä»¥å€ŸåŠ© æ³¨è§£ @Qualifier(value = "bean3") æ¥æ³¨å…¥ã€‚

```java
@Data
static class Bean1 {
    public Bean1() {
        System.out.println("init Bean1");
    }
    @Autowired
    @Qualifier(value = "bean3")
    private Inner inner;
}
```

**å¦‚æœå¯¹è±¡åŒæ—¶æ·»åŠ äº† @Autowired å’Œ @Resource(name = "bean4")ï¼Œé‚£ä¹ˆçœŸå®æ³¨å…¥çš„å¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ**

```java
@Data
static class Bean1 {
    public Bean1() {
        System.out.println("init Bean1");
    }
    @Autowired
    @Resource(name = "bean4")
    private Inner bean3;
}
```

æ‰§è¡Œç»“æœï¼š

```java
TestBeanFactory.Bean3()
```

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ è¿™å°±æ˜¯beanFactoryåç½®å¤„ç†å™¨çš„æ·»åŠ é¡ºåºäº†ã€‚

```java
beanFactory.getBeansOfType(BeanPostProcessor.class).values()
                .forEach(beanPostProcessor -> {
                            System.out.println("beanPostProcessor...  " + beanPostProcessor.getClass().getName());
                            beanFactory.addBeanPostProcessor(beanPostProcessor);
                        }
                );
```
æŸ¥çœ‹ç»“æœï¼š

```java
beanPostProcessor...  org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor
beanPostProcessor...  org.springframework.context.annotation.CommonAnnotationBeanPostProcessor
```

**å¦‚ä½•æ§åˆ¶åç½®å¤„ç†å™¨çš„æ·»åŠ é¡ºåºå‘¢ï¼Ÿ**

```java
beanFactory.getBeansOfType(BeanPostProcessor.class).values()
                .stream().sorted(beanFactory.getDependencyComparator())
                .forEach(beanPostProcessor -> {
                            System.out.println("beanPostProcessor...  " + beanPostProcessor.getClass().getName());
                            beanFactory.addBeanPostProcessor(beanPostProcessor);
                        }
                );
```

æ‰§è¡Œç»“æœï¼š

```java
beanPostProcessor...  org.springframework.context.annotation.CommonAnnotationBeanPostProcessor
beanPostProcessor...  org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor
```

**æ’åºæ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Ÿ**

![](https://oscimg.oschina.net/oscnet/up-8e5e7d76b4ea357ea545d790b0f68f14bd0.png)

> orderæ•°å€¼è¶Šå° ä¼˜å…ˆåŠ å…¥ã€‚

ä¸‹é¢æ˜¯2ä¸ªåç½®å¤„ç†å™¨çš„å®šä¹‰å’Œæ„é€ å‡½æ•°ï¼š
```java

 public CommonAnnotationBeanPostProcessor() {
        this.setOrder(2147483644);
        this.setInitAnnotationType(PostConstruct.class);
        this.setDestroyAnnotationType(PreDestroy.class);
        this.ignoreResourceType("javax.xml.ws.WebServiceContext");
}


public class AutowiredAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware {
    protected final Log logger = LogFactory.getLog(this.getClass());
    private final Set<Class<? extends Annotation>> autowiredAnnotationTypes = new LinkedHashSet(4);
    private String requiredParameterName = "required";
    private boolean requiredParameterValue = true;
    private int order = 2147483645;
    ...
}    
```


## 3. ApplicationContextçš„å®ç°


> ApplicationContextçš„å››ç§å®ç°ï¼›

### 3.1 å±•ç¤ºClassPathXmlApplicationContextåŠ è½½å’Œè·å–bean

ä¸‹é¢çœ‹ä¸€ä¸‹æœ€ä¸ºç²¾ç®€çš„springå®¹å™¨ï¼šä»¥å¤§å®¶ç†ŸçŸ¥çš„ClassPathXmlApplicationContextä¸ºä¾‹ï¼š

```java
public class TestApplicationContext {
    public static void main(String[] args) {
        testXmlPath();
    }

    private static void testXmlPath(){
        ClassPathXmlApplicationContext applicationContext = new ClassPathXmlApplicationContext("b01.xml");
        String[] beanDefinitionNames = applicationContext.getBeanDefinitionNames();
        for (String name : beanDefinitionNames) {
            System.out.println("name : " + name);
        }

        System.out.println(applicationContext.getBean("bean1"));
    }
}
```
**beançš„å®šä¹‰æ–‡ä»¶ï¼Œb01.xmlæ–‡ä»¶å¦‚ä¸‹ã€‚**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <beans>
        <bean id="bean1" class="com.example.testspring.beans.TestBeanFactory.Bean1"/>
        <bean id="bean2" class="com.example.testspring.beans.TestBeanFactory.Bean2"/>
    </beans>
</beans>
```
**æŸ¥çœ‹æ‰§è¡Œæ•ˆæœï¼š**

```java
19:29:47.662 [main] DEBUG org.springframework.beans.factory.xml.XmlBeanDefinitionReader - Loaded 2 bean definitions from class path resource [b01.xml]
19:29:47.749 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean1'
init Bean1
19:29:47.764 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean2'
init Bean2
name : bean1
name : bean2
TestBeanFactory.Bean1(bean3=null)
```

å¯ä»¥çœ‹åˆ°è¿™ç§åŸºäºxmlæ–‡ä»¶çš„é…ç½®æ–¹å¼ï¼Œéå¸¸ç¹çã€‚


### 3.2 ClassPathXmlApplicationContextå¦‚ä½•è¯»å–xmlä¸­çš„beané…ç½®ç„¶ååŠ è½½åˆ°beanFactoryä¸­çš„ï¼Ÿ



```java
public static void main(String[] args) {

        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.err.println("beanDefinitionNames : " + beanDefinitionName);
        }

        // ä¸€å¼€å§‹beanFactoryæ²¡æœ‰ä»»ä½•çš„beanå®šä¹‰
        System.out.println(".........");

        // é€šè¿‡XmlBeanDefinitionReaderè¯»å–xmlçš„beanå®šä¹‰ä¿¡æ¯ï¼Œå¹¶ä¸”å­˜æ”¾åˆ°beanFactoryä¸­
        XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(beanFactory);
        reader.loadBeanDefinitions(new ClassPathResource("b01.xml"));
        String[] beanDefinitionNames1 = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames1) {
            System.err.println("beanDefinitionNames : " + beanDefinitionName);
        }

}
```
**æ‰§è¡Œç»“æœ:**
```java
.........
19:24:33.512 [main] DEBUG org.springframework.beans.factory.xml.XmlBeanDefinitionReader - Loaded 2 bean definitions from class path resource [b01.xml]
beanDefinitionNames : bean1
beanDefinitionNames : bean2
```


### 3.3 AnnotationConfigApplicationContextåŠ è½½å’Œè·å–bean

> åŸºäºæ³¨è§£é…ç½®çš„æ–¹å¼åŠ è½½beanå®šä¹‰

```java
private static void testAnnotationConfiqApplicationContext(){
        AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext(Config.class);
        for (String name : applicationContext.getBeanDefinitionNames()) {
            System.out.println("name : " + name);
        }
    }

    @Configuration
    static class Config {

        @Bean("bean1")
        public Bean1 getBean1(){
            return new Bean1();
        }

        @Bean("bean2")
        public Bean2 getBean2(Bean1 bean1){
            Bean2 bean2 = new Bean2();
            bean2.setBean1(bean1);
            return bean2;
        }

    }

    @Data
    @NoArgsConstructor
    static class Bean1{

    }

    @Data
    @NoArgsConstructor
    static class Bean2 {
        private Bean1 bean1;
    }
```
è¿è¡Œç»“æœï¼š

```java
19:43:04.578 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Autowiring by type from bean name 'bean2' via factory method to bean named 'bean1'
name : org.springframework.context.annotation.internalConfigurationAnnotationProcessor
name : org.springframework.context.annotation.internalAutowiredAnnotationProcessor
name : org.springframework.context.annotation.internalCommonAnnotationProcessor
name : org.springframework.context.event.internalEventListenerProcessor
name : org.springframework.context.event.internalEventListenerFactory
name : testApplicationContext.Config
name : bean1
name : bean2
```
è¿™é‡Œæˆ‘ä»¬ä¸ä»…å¯ä»¥çœ‹åˆ°bean1å’Œbean2,è¿˜å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„é…ç½®ç±» `testApplicationContext.Config`ã€‚  

è€Œä¸”ï¼Œçœ‹æ‰“å°ç»“æœï¼ŒAnnotationConfigApplicationContextæŠŠä¸€äº›é»˜è®¤çš„åç½®å¤„ç†å™¨ä¹Ÿéƒ½åŠ ä¸Šäº†ã€‚



### 3.4 AnnotationConfigServletWebServerApplicationContext webåº”ç”¨å®¹å™¨

```java
private static void testAnnotationConfigServletWebServerApplicationContext(){
        AnnotationConfigServletWebServerApplicationContext context = new AnnotationConfigServletWebServerApplicationContext(WebConfig.class);
        for (String name : context.getBeanDefinitionNames()) {
            System.out.println("name : " + name);
        }
    }

    @Configuration
    static class WebConfig{
    	// é…ç½®server
        @Bean
        public ServletWebServerFactory servletWebServerFactory (){
            return new TomcatServletWebServerFactory();
        }
        // é…ç½®è¯·æ±‚åˆ†å‘å™¨
        @Bean
        public DispatcherServlet dispatchServlet (){
            return new DispatcherServlet();
        }
        // é…ç½®serverå’ŒdispatchServletçš„ç»‘å®šå…³ç³»
        @Bean
        public DispatcherServletRegistrationBean dispatcherServletRegistrationBean(DispatcherServlet dispatcherServlet){
            // path æ˜¯é™åˆ¶å“ªäº›è¯·æ±‚ç»è¿‡dispatchServletæ¥è¿›è¡Œåˆ†å‘
            return new DispatcherServletRegistrationBean(dispatcherServlet, "/");
        }
        // å£°æ˜ä¸€ä¸ªcontroller
        @Bean("/hello")
        public Controller myController(){
            return ((httpServletRequest, httpServletResponse) -> {
                httpServletResponse.getWriter().println("hello....");
                return null;
            });
        }
    }
```


## 4. Spring Beansçš„ç”Ÿå‘½å‘¨æœŸ

### 4.1 beançš„ç”Ÿå‘½å‘¨æœŸ

```java
@Component
public class LifeCycleBean {

    public LifeCycleBean(){
        System.out.println("init LifeCycleBean");
    }

    @Autowired
    public void autowire(@Value("java_home") String javaHome){
        System.out.println("javaHome = " + javaHome);
    }

    @PostConstruct
    public void init(){
        System.out.println("åˆå§‹åŒ–");
    }

    @PreDestroy
    public void destroy(){
        System.out.println("é”€æ¯");
    }

}
```

```java
@SpringBootApplication
public class TestSpringApplication {
    public static void main(String[] args)  {
        ConfigurableApplicationContext context = SpringApplication.run(TestSpringApplication.class, args);
        context.close();;
    }
}
```


### 4.2 beançš„åç½®å¤„ç†å™¨

ä¸‹é¢çœ‹ä¸€ä¸‹BeanPostProcessorï¼Œ**å¯ä»¥å¯¹beanåšä¸€äº›åŠŸèƒ½çš„å¢å¼º**ã€‚

```java
@Slf4j
@Component
public class MyBeanPostProcessor implements InstantiationAwareBeanPostProcessor, DestructionAwareBeanPostProcessor {
    @Override
    // å®ä¾‹åŒ–å‰ï¼ˆå³è°ƒç”¨æ„é€ æ–¹æ³•å‰ï¼‰æ‰§è¡Œçš„æ–¹æ³•
    public Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) throws BeansException {
        if (beanName.equals("lifeCycleBean"))
            System.out.println("<<<<<<<<<<< å®ä¾‹åŒ–å‰æ‰§è¡Œï¼Œå¦‚@PreDestroy");
        // è¿”å›nullä¿æŒåŸæœ‰å¯¹è±¡ä¸å˜ï¼Œè¿”å›ä¸ä¸ºnullï¼Œä¼šæ›¿æ¢æ‰åŸæœ‰å¯¹è±¡
        return null;
    }

    @Override
    // å®ä¾‹åŒ–åæ‰§è¡Œçš„æ–¹æ³•
    public boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException {
        if (beanName.equals("lifeCycleBean")) {
            System.out.println("<<<<<<<<<<< å®ä¾‹åŒ–åæ‰§è¡Œï¼Œè¿™é‡Œå¦‚æœè¿”å› false ä¼šè·³è¿‡ä¾èµ–æ³¨å…¥é˜¶æ®µ");
            // return false;
        }

        return true;
    }

    @Override
    // ä¾èµ–æ³¨å…¥é˜¶æ®µæ‰§è¡Œçš„æ–¹æ³•
    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) throws BeansException {
        if (beanName.equals("lifeCycleBean"))
            System.out.println("<<<<<<<<<<< ä¾èµ–æ³¨å…¥é˜¶æ®µæ‰§è¡Œï¼Œå¦‚@Autowiredã€@Valueã€@Resource");
        return pvs;
    }

    @Override
    // é”€æ¯å‰æ‰§è¡Œçš„æ–¹æ³•
    public void postProcessBeforeDestruction(Object bean, String beanName) throws BeansException {
        if (beanName.equals("lifeCycleBean"))
            System.out.println("<<<<<<<<<<<é”€æ¯ä¹‹å‰æ‰§è¡Œ");
    }

    @Override
    // åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (beanName.equals("lifeCycleBean"))
            System.out.println("<<<<<<<<<<< åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œï¼Œè¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„beanï¼Œå¦‚ @PostConstructã€@ConfigurationProperties");
        return bean;
    }

    @Override
    // åˆå§‹åŒ–ä¹‹åæ‰§è¡Œçš„æ–¹æ³•
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        if (beanName.equals("lifeCycleBean"))
            System.out.println("<<<<<<<<<<< åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œè¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„beanï¼Œå¦‚ ä»£ç†å¢å¼º");
        return bean;
    }
}
```
**æ‰§è¡Œç»“æœï¼š**

```java
<<<<<<<<<<< å®ä¾‹åŒ–å‰æ‰§è¡Œï¼Œå¦‚@PreDestroy
init LifeCycleBean
<<<<<<<<<<< å®ä¾‹åŒ–åæ‰§è¡Œï¼Œè¿™é‡Œå¦‚æœè¿”å› false ä¼šè·³è¿‡ä¾èµ–æ³¨å…¥é˜¶æ®µ
<<<<<<<<<<< ä¾èµ–æ³¨å…¥é˜¶æ®µæ‰§è¡Œï¼Œå¦‚@Autowiredã€@Valueã€@Resource
javaHome = java_home
<<<<<<<<<<< åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œï¼Œè¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„beanï¼Œå¦‚ @PostConstructã€@ConfigurationProperties
åˆå§‹åŒ–
<<<<<<<<<<< åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œè¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„beanï¼Œå¦‚ ä»£ç†å¢å¼º
2022-11-28 20:34:27.519  INFO 2260 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'
2022-11-28 20:34:27.676  INFO 2260 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2022-11-28 20:34:27.687  INFO 2260 --- [           main] c.e.t.test3.TestSpringApplication        : Started TestSpringApplication in 1.938 seconds (JVM running for 2.513)
2022-11-28 20:34:28.956  INFO 2260 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'
<<<<<<<<<<<é”€æ¯ä¹‹å‰æ‰§è¡Œ
é”€æ¯
```


### 4.3 æ¨¡ç‰ˆæ–¹æ³•-è®¾è®¡æ¨¡å¼



```java
public class TestMethodTemplatePattern {
    public static void main(String[] args) {
        MyBeanFactory beanFactory = new MyBeanFactory();
        beanFactory.addBeanPostProcessor(bean -> System.out.println("è§£æ @Autowired"));
        beanFactory.addBeanPostProcessor(bean -> System.out.println("è§£æ @Resource"));
        beanFactory.getBean();
    }

    static class MyBeanFactory {
        public Object getBean() {
            Object bean = new Object();
            System.out.println("æ„é€ ï¼š" + bean);
            System.out.println("ä¾èµ–æ³¨å…¥ï¼š" + bean);
            for (BeanPostProcessor processor : processors) {
                processor.inject(bean);
            }
            System.out.println("åˆå§‹åŒ–ï¼š" + bean);
            return bean;
        }

        private List<BeanPostProcessor> processors = new ArrayList<>();

        public void addBeanPostProcessor(BeanPostProcessor beanPostProcessor) {
            processors.add(beanPostProcessor);
        }
    }

    interface BeanPostProcessor {
        void inject(Object bean);
    }
}

```

**è¿è¡Œç»“æœï¼š**

```java
æ„é€ ï¼šjava.lang.Object@5e9f23b4
ä¾èµ–æ³¨å…¥ï¼šjava.lang.Object@5e9f23b4
è§£æ @Autowired
è§£æ @Resource
åˆå§‹åŒ–ï¼šjava.lang.Object@5e9f23b4
```

è¿™ç§æ–¹å¼çš„å¥½å¤„å°±æ˜¯åœ¨æ‰©å±•åŠŸèƒ½çš„æ—¶å€™ï¼Œä¸éœ€è¦ä¿®æ”¹åŸæ¥ä»£ç çš„é€»è¾‘ï¼Œåªéœ€è¦æŒ‰éœ€æ·»åŠ æ–°çš„åŠŸèƒ½å°±å¯ä»¥äº†ã€‚


















