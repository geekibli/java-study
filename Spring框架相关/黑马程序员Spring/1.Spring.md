




## 1.BeanFactoryå’ŒApplicationContext


### 1.1 åˆ°åº•ä»€ä¹ˆæ˜¯BeanFactory

1. å®ƒæ˜¯ApplicationContextçš„çˆ¶æ¥å£
2. å®ƒæ‰æ˜¯Springçš„æ ¸å¿ƒå®¹å™¨, ä¸»è¦çš„ApplicationContext å®ç°/ç»„åˆ äº†å®ƒçš„åŠŸèƒ½



### 1.2 BeanFactoryèƒ½åšä»€ä¹ˆ

1. è¡¨é¢ä¸Šåªæœ‰getBean
2. å®é™…ä¸Šæ§åˆ¶åè½¬ã€åŸºæœ¬çš„ä¾èµ–ï¼Œæ³¨å…¥ã€ç›´è‡³Beançš„ç”Ÿå‘½å‘¨æœŸçš„å„ç§åŠŸèƒ½ï¼Œéƒ½ç”±å®ƒçš„å®ç°ç±»æä¾›
3. å®ƒå¯ä»¥ç®¡ç†æ‰€æœ‰çš„bean
	

ä¸‹é¢é€šè¿‡åå°„æ–¹å¼æ‹¿åˆ°beanFactoryä¸­çš„å•ä¾‹beanï¼Œå½“ç„¶æ˜¯é™å®šçš„ä¸€äº›ç±»ï¼š

```java
public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException {
        ConfigurableApplicationContext context = SpringApplication.run(TestSpringApplication.class, args);

        Field singletonObjects = DefaultSingletonBeanRegistry.class.getDeclaredField("singletonObjects");
        singletonObjects.setAccessible(true);
        ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();
        Map<String, Object> map = (Map<String, Object>) singletonObjects.get(beanFactory);
        map.entrySet().stream().filter(e -> e.getKey().startsWith("component"))
                .forEach(e -> {
                    System.err.println(e.getKey() + "   " + e.getValue());
                });
    }
```

![](https://oscimg.oschina.net/oscnet/up-2817b1229a9ef68d7856a9db4294f3a4bc7.png)


### 1.3 ApplicationContextæ¯”BeanFactoryæ‰©å±•äº†å“ªäº›åŠŸèƒ½


![](https://oscimg.oschina.net/oscnet/up-8f860ac2720e02b1276316a46d70ac586c3.png)


- MessageSource: å›½é™…åŒ–è¯­è¨€æ”¯æŒèƒ½åŠ›
- ResourcePatternResolverï¼šä¸€äº›é€šé…ç¬¦çš„æ”¯æŒèƒ½åŠ›
- ApplicationEventPublisherï¼š äº‹ä»¶å‘å¸ƒèƒ½åŠ›
- EnvironmentCapableï¼š ç¯å¢ƒä¿¡æ¯è¯»å–èƒ½åŠ›ï¼Œç³»ç»Ÿå˜é‡å’Œé…ç½®æ–‡ä»¶


**ä¸‹é¢çœ‹ä¸€ä¸‹MessageSourceèƒ½åŠ›çš„å±•ç¤ºï¼š**

![](https://oscimg.oschina.net/oscnet/up-ad1583066a2d339fab7994f113878c1e447.png)


**contextè·å–èµ„æº**
```java
 Resource[] resources = context.getResources("classpath:application.properties");
        for (Resource resource : resources) {
            System.err.println(resource);
        }

Resource[] resources = context.getResources("classpath*:MATE-INF/spring.factories");
        for (Resource resource : resources) {
            System.err.println(resource);
        }
```
è¾“å‡ºç»“æœ: 
```java
class path resource [application.properties]
```


**contextè·å–ç¯å¢ƒé…ç½®**
```java
System.err.println(context.getEnvironment().getPropertySources().get("java_home"));
System.err.println(context.getEnvironment().getProperty("java_home"));
System.err.println(context.getEnvironment().getProperty("spring.profiles.active"));
```

**äº‹ä»¶å‘å¸ƒä¸ç›‘å¬**
![](https://oscimg.oschina.net/oscnet/up-56692d6e9e11a092596b81ca73312c39030.png)


> **äº‹ä»¶çš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡Œè§£è€¦åˆã€‚**


## 2.å®¹å™¨çš„å®ç°

### 2.1 beançš„å£°æ˜å’Œå®šä¹‰
```java
package com.example.testspring.beans;

import lombok.Data;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.support.AbstractBeanDefinition;
import org.springframework.beans.factory.support.BeanDefinitionBuilder;
import org.springframework.beans.factory.support.DefaultListableBeanFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

public class TestBeanFactory {
    public static void main(String[] args) {
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
        beanFactory.registerBeanDefinition("config", beanDefinition);

        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.out.println("beanDefinitionName : " + beanDefinitionName);
        }
    }

    @Configuration
    static class Config{
        @Bean
        public Bean1 getBean1(){
            return new Bean1();
        }

        @Bean
        public Bean2 getBean2(){
            return new Bean2();
        }
    }

    @Data
    static class Bean1 {

        public Bean1 (){
            System.out.println("init Bean1");
        }

        @Autowired
        private Bean2 bean2;

    }

    @Data
    static class Bean2 {
        public Bean2 (){
            System.out.println("init Bean2");
        }
    }

}

```
**è¾“å‡ºç»“æœï¼š**

```java
beanDefinitionName : config
```

è¿è¡Œä»¥ä¸Šmainæ–¹æ³•ï¼Œå‘ç°åˆæœ‰ä¸€ä¸ªbeanDefinitionï¼Œ**é‚£ä¸ºä»€ä¹ˆBean1 , Bean2 æ²¡æœ‰æ‰“å°å‡ºæ¥å‘¢ï¼Ÿ**


å› ä¸ºåŸå§‹çš„DefaultListableBeanFactoryå¹¶æ²¡æœ‰èƒ½åŠ›å¤„ç†@Beanï¼Œ @Configuration è¿™æ ·çš„æ³¨è§£ï¼Œéœ€è¦å€ŸåŠ©ä¸€ä¸ªå·¥å…·ç±»ï¼š

```java
public static void main(String[] args) {
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
        beanFactory.registerBeanDefinition("config", beanDefinition);

        // ç»™ beanFactory æ·»åŠ ä¸€äº›å¸¸ç”¨çš„åç½®å¤„ç†å™¨
        AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);
        
        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.out.println("beanDefinitionName : " + beanDefinitionName);
        }
    }
```
**è¿è¡Œç»“æœï¼š**
```java
beanDefinitionName : config
beanDefinitionName : org.springframework.context.annotation.internalConfigurationAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalAutowiredAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalCommonAnnotationProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerFactory
```


è¿™é‡Œå¯ä»¥çœ‹åˆ°å¢åŠ äº†ä¸€äº›Springé»˜è®¤çš„beanFactoryåç½®å¤„ç†å™¨ï¼Œæ¯”å¦‚ï¼ŒinternalConfigurationAnnotationProcessorã€‚
è¿™æ˜¯Springå†…ç½®çš„æ³¨è§£é…ç½®ç±»çš„å¤„ç†å™¨ï¼Œç°åœ¨å®ƒæ˜¯å‡ºç°åœ¨äº†BeanFactoryä¸­äº†ï¼Œä½†æ˜¯ç”±äºå®ƒè¿˜æ²¡æœ‰å·¥ä½œï¼Œæ‰€ä»¥ï¼Œæ‰“å°çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬ä¾æ—§çœ‹ä¸åˆ°Bean1,Bean2ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œè¿™äº›åç½®å¤„ç†å™¨çš„åç½®å¤„ç†æ–¹æ³•ï¼š

```java
public static void main(String[] args) {
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
        beanFactory.registerBeanDefinition("config", beanDefinition);

        // ç»™ beanFactory æ·»åŠ ä¸€äº›å¸¸ç”¨çš„åç½®å¤„ç†å™¨
        AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);

        beanFactory.getBeansOfType(BeanFactoryPostProcessor.class)
                .values().stream()
                .forEach(beanFactoryPostProcessor -> {
                    beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);
                });

        String[] beanDefinitionNames = beanFactory.getBeanDefinitionNames();
        for (String beanDefinitionName : beanDefinitionNames) {
            System.out.println("beanDefinitionName : " + beanDefinitionName);
        }
    }
```

**é…ç½®ç±»å¦‚ä¸‹ï¼š**  

> è¿™é‡Œè®¾ç½®äº†ä¸€ä¸‹beançš„åå­—

```java
@Configuration
    static class Config{
        @Bean(name = "bean1")
        public Bean1 getBean1(){
            return new Bean1();
        }

        @Bean(name = "bean2")
        public Bean2 getBean2(){
            return new Bean2();
        }
    }
```
å¦‚æœä¸è®¾ç½® `@Bean(name = "bean1")`ï¼Œ æ‰“å°å‡ºæ¥çš„beanDefinitionNameå°±æ˜¯æ–¹æ³•çš„åå­—ã€‚ **getBean1**

**æ‰§è¡Œç»“æœï¼š**
```java
beanDefinitionName : config
beanDefinitionName : org.springframework.context.annotation.internalConfigurationAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalAutowiredAnnotationProcessor
beanDefinitionName : org.springframework.context.annotation.internalCommonAnnotationProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerProcessor
beanDefinitionName : org.springframework.context.event.internalEventListenerFactory
beanDefinitionName : bean1
beanDefinitionName : bean2
```

ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒBean1, Bean2æ˜¯æ‰“å°å‡ºæ¥äº†ã€‚


### 2.2 å¦‚ä½•ä½¿ç”¨bean

```java
System.err.println(beanFactory.getBean(Bean1.class).getBean2());
```
**è¿è¡Œç»“æœï¼š**

```java
init Bean1
null
```
å¯ä»¥çœ‹åˆ°ï¼Œbean2çš„å®ä¾‹æ‰“å°ç»“æœæ˜¯ç©ºã€‚ä¸ºä»€ä¹ˆï¼Œ**å¯¹è±¡æ³¨å…¥æ²¡æœ‰ç”Ÿæ•ˆ**ã€‚

éœ€è¦beançš„åç½®å¤„ç†å™¨ `org.springframework.context.annotation.internalAutowiredAnnotationProcessor` æ¥å¤„ç†å¯¹åº”çš„æ–¹æ³•æ¥å¤„ç† @Autowired æ³¨è§£ã€‚

é’ˆå¯¹Beançš„å£°æ˜å‘¨æœŸçš„å„ä¸ªé˜¶æ®µæä¾›æ‰©å±•ï¼Œæ¯”å¦‚ @Autowired, @Resource...

**æŠŠbeanPostProcessoræ·»åŠ åˆ°beanFactoryä¸­**

```java
beanFactory.getBeansOfType(BeanPostProcessor.class).values().forEach(beanFactory::addBeanPostProcessor);

        System.err.println(beanFactory.getBean(Bean1.class).getBean2());
```
**å†æ¬¡æŸ¥çœ‹è¿è¡Œç»“æœï¼š**

```java
21:56:59.269 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean1'
21:56:59.270 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'config'
init Bean1
21:56:59.309 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean2'
init Bean2
TestBeanFactory.Bean2()
```

**æ³¨æ„**ï¼šå•ä¾‹beanå¹¶ä¸æ˜¯beanFactoryä¸€å¼€å§‹å°±éƒ½åˆ›å»ºå¥½çš„ï¼Œè€Œæ˜¯ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæ‰å›å»åˆå§‹åŒ–ã€‚

å¦‚æœéœ€è¦äº‹å…ˆå°±åˆå§‹åŒ–æ‰€æœ‰çš„å•ä¾‹å¯¹è±¡ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªæ–¹æ³•ï¼š

```java
beanFactory.preInstantiateSingletons();
```

### 2.3 beanFactoryå°ç»“

**a. beanFactoryä¸ä¼šä¸»åŠ¨å»åšçš„äº‹**

1. ä¸ä¼šä¸»åŠ¨è°ƒç”¨BeanFactory åç½®å¤„ç†å™¨
2. ä¸ä¼šä¸»åŠ¨æ·»åŠ Benaåç½®å¤„ç†å™¨
3. ä¸ä¼šä¸»åŠ¨åˆå§‹åŒ–å•ä¾‹bean
4. ä¸ä¼šè§£æbeanFactory,è¿˜ä¸ä¼šè§£æ ${} å’Œ #{}


**b. beanFactoryåç½®å¤„ç†å™¨æœ‰æ’åºçš„é€»è¾‘ã€‚**

> beanFactoryå¾ˆå¤šåŸºç¡€çš„åŠŸèƒ½éƒ½æ²¡æœ‰ä¸»åŠ¨å»åšã€‚éœ€è¦æ‰‹åŠ¨å»æŠŠåç½®å¤„ç†å™¨è®¾ç½®å¥½åæ‰å¯ä»¥ä½¿ç”¨ã€‚



### 2.4 beanFactoryæ‰©å±•-åç½®å¤„ç†å™¨é¡ºåº

åç½®å¤„ç†å™¨çš„æ·»åŠ é¡ºåºå¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªæ–¹æ³•çš„æºç  ğŸ‘‡ï¼š

```java
org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object)
```

å¯ä»¥çœ‹åˆ°@Autowiredçš„å¤„ç†å™¨åŠ åœ¨@Resourceçš„æ¢³ç†å™¨å‰é¢ã€‚å­˜å‚¨çš„ç»“æ„æ˜¯ `Set<BeanDefinitionHolder> beanDefs = new LinkedHashSet(8);`

**å¦‚æœä¸€ä¸ªå±æ€§æ³¨å…¥æ˜¯ï¼Œå³æœ‰ @Autowired åˆæœ‰ @Resourceæ³¨è§£ï¼Œä¼šæ€æ ·ï¼Ÿ** ä¸‹é¢å°è¯•ä¸€ä¸‹ï¼š

å¢åŠ ä¸¤ä¸ªbeanï¼ŒåŒæ—¶åŠ åˆ°å®¹å™¨ä¸­ï¼ˆ@Configuration + @Beanï¼‰

```java
 interface Inner {
        
    }
    
@Data
static class Bean3 implements Inner {
    
    public Bean3(){
        System.out.println("init Bean3");
    }
}

@Data
static class Bean4 implements Inner {

    public Bean4(){
        System.out.println("init Bean4");
    }
}
```

å¦‚æœæ³¨å…¥çš„ç±»å‹æ˜¯ `Inner` æ¥å£ç±»å‹ï¼Œä¼šæ€æ ·ï¼Ÿ

![](https://oscimg.oschina.net/oscnet/up-de5c6eb457b97ded607e1f6abbc36af2b4c.png)

ä¼šæœ‰ç¼–è¯‘é”™è¯¯ï¼Œæç¤ºæœ‰2ä¸ªç±»å‹ï¼ŒBean3 å’Œ Bean4ï¼Œæ²¡æœ‰æ˜ç¡®è¦æ³¨å…¥é‚£ä¸ªç±»å‹ã€‚

ä½†æ˜¯å¦‚æœè¦æ˜¯æ”¹ä¸€ä¸‹æ³¨å…¥çš„å˜é‡åç§°å‘¢ï¼Ÿ

```java
 @Data
static class Bean1 {
    public Bean1() {
        System.out.println("init Bean1");
    }
    @Autowired
    private Inner bean3;
}
```
**å¯ä»¥çœ‹åˆ°æ˜¯å¯ä»¥æ­£ç¡®æ³¨å…¥çš„ã€‚**

ç”±æ­¤å¯ä»¥çŸ¥é“ @Autowired ä¼˜å…ˆæŒ‰ç…§ç±»å‹æ³¨å…¥ï¼Œå¦‚æœç±»å‹ä¸èƒ½ç¡®å®šå”¯ä¸€ï¼Œéœ€è¦æŒ‡å®šåç§°æ³¨å…¥ã€‚

æˆ–è€…å¯ä»¥å€ŸåŠ© æ³¨è§£ @Qualifier(value = "bean3") æ¥æ³¨å…¥ã€‚

```java
@Data
static class Bean1 {
    public Bean1() {
        System.out.println("init Bean1");
    }
    @Autowired
    @Qualifier(value = "bean3")
    private Inner inner;
}
```

**å¦‚æœå¯¹è±¡åŒæ—¶æ·»åŠ äº† @Autowired å’Œ @Resource(name = "bean4")ï¼Œé‚£ä¹ˆçœŸå®æ³¨å…¥çš„å¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ**

```java
@Data
static class Bean1 {
    public Bean1() {
        System.out.println("init Bean1");
    }
    @Autowired
    @Resource(name = "bean4")
    private Inner bean3;
}
```

æ‰§è¡Œç»“æœï¼š

```java
TestBeanFactory.Bean3()
```

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ è¿™å°±æ˜¯beanFactoryåç½®å¤„ç†å™¨çš„æ·»åŠ é¡ºåºäº†ã€‚

```java
beanFactory.getBeansOfType(BeanPostProcessor.class).values()
                .forEach(beanPostProcessor -> {
                            System.out.println("beanPostProcessor...  " + beanPostProcessor.getClass().getName());
                            beanFactory.addBeanPostProcessor(beanPostProcessor);
                        }
                );
```
æŸ¥çœ‹ç»“æœï¼š

```java
beanPostProcessor...  org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor
beanPostProcessor...  org.springframework.context.annotation.CommonAnnotationBeanPostProcessor
```

**å¦‚ä½•æ§åˆ¶åç½®å¤„ç†å™¨çš„æ·»åŠ é¡ºåºå‘¢ï¼Ÿ**

```java
beanFactory.getBeansOfType(BeanPostProcessor.class).values()
                .stream().sorted(beanFactory.getDependencyComparator())
                .forEach(beanPostProcessor -> {
                            System.out.println("beanPostProcessor...  " + beanPostProcessor.getClass().getName());
                            beanFactory.addBeanPostProcessor(beanPostProcessor);
                        }
                );
```

æ‰§è¡Œç»“æœï¼š

```java
beanPostProcessor...  org.springframework.context.annotation.CommonAnnotationBeanPostProcessor
beanPostProcessor...  org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor
```

**æ’åºæ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Ÿ**

![](https://oscimg.oschina.net/oscnet/up-8e5e7d76b4ea357ea545d790b0f68f14bd0.png)

> orderæ•°å€¼è¶Šå° ä¼˜å…ˆåŠ å…¥ã€‚

ä¸‹é¢æ˜¯2ä¸ªåç½®å¤„ç†å™¨çš„å®šä¹‰å’Œæ„é€ å‡½æ•°ï¼š
```java

 public CommonAnnotationBeanPostProcessor() {
        this.setOrder(2147483644);
        this.setInitAnnotationType(PostConstruct.class);
        this.setDestroyAnnotationType(PreDestroy.class);
        this.ignoreResourceType("javax.xml.ws.WebServiceContext");
}


public class AutowiredAnnotationBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware {
    protected final Log logger = LogFactory.getLog(this.getClass());
    private final Set<Class<? extends Annotation>> autowiredAnnotationTypes = new LinkedHashSet(4);
    private String requiredParameterName = "required";
    private boolean requiredParameterValue = true;
    private int order = 2147483645;
    ...
}    
```























